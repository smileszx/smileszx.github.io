<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>Redis核心知识梳理 | 好奇的蜗牛</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Redis核心知识梳理一、Redis基础1 Redis介绍 Redis是内存数据库 C语言编写 单线程 单线程如何保证并发性能？epoll   键值对Key-Value方式存储数据 持久化方式：RDB和AOF Redis集群 数据过期处理：LRU  1.1 Redis应用场景Redis应用场景，面试中常被问到，“请问你在项目中哪些场景用到Redis，请举例说明。” 1.1.1 内存数据库登录信息、">
<meta name="keywords" content="Redis">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis核心知识梳理">
<meta property="og:url" content="http://techsnail.com/2019/06/29/Redis核心知识梳理/index.html">
<meta property="og:site_name" content="好奇的蜗牛">
<meta property="og:description" content="Redis核心知识梳理一、Redis基础1 Redis介绍 Redis是内存数据库 C语言编写 单线程 单线程如何保证并发性能？epoll   键值对Key-Value方式存储数据 持久化方式：RDB和AOF Redis集群 数据过期处理：LRU  1.1 Redis应用场景Redis应用场景，面试中常被问到，“请问你在项目中哪些场景用到Redis，请举例说明。” 1.1.1 内存数据库登录信息、">
<meta property="og:locale" content="default">
<meta property="og:image" content="e:/Architect/TechSnail/Redis/Redis核心知识梳理.assets/1568686851026.png">
<meta property="og:image" content="e:/Architect/TechSnail/Redis/Redis核心知识梳理.assets/1569068020757.png">
<meta property="og:image" content="e:/Architect/TechSnail/Redis/Redis核心知识梳理.assets/1569068491782.png">
<meta property="og:updated_time" content="2019-09-24T02:44:54.157Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Redis核心知识梳理">
<meta name="twitter:description" content="Redis核心知识梳理一、Redis基础1 Redis介绍 Redis是内存数据库 C语言编写 单线程 单线程如何保证并发性能？epoll   键值对Key-Value方式存储数据 持久化方式：RDB和AOF Redis集群 数据过期处理：LRU  1.1 Redis应用场景Redis应用场景，面试中常被问到，“请问你在项目中哪些场景用到Redis，请举例说明。” 1.1.1 内存数据库登录信息、">
<meta name="twitter:image" content="e:/Architect/TechSnail/Redis/Redis核心知识梳理.assets/1568686851026.png">
  
    <link rel="alternate" href="/atom.xml" title="好奇的蜗牛" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">好奇的蜗牛</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">我要一步一步往上爬，等待阳光静静看着它的脸，小小的天有大大的梦想！</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://techsnail.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Redis核心知识梳理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/29/Redis核心知识梳理/" class="article-date">
  <time datetime="2019-06-29T07:53:30.000Z" itemprop="datePublished">2019-06-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Redis核心知识梳理
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Redis核心知识梳理"><a href="#Redis核心知识梳理" class="headerlink" title="Redis核心知识梳理"></a>Redis核心知识梳理</h1><h2 id="一、Redis基础"><a href="#一、Redis基础" class="headerlink" title="一、Redis基础"></a>一、Redis基础</h2><h3 id="1-Redis介绍"><a href="#1-Redis介绍" class="headerlink" title="1 Redis介绍"></a>1 Redis介绍</h3><ul>
<li>Redis是内存数据库</li>
<li>C语言编写</li>
<li>单线程<ul>
<li>单线程如何保证并发性能？epoll</li>
</ul>
</li>
<li>键值对Key-Value方式存储数据</li>
<li>持久化方式：RDB和AOF</li>
<li>Redis集群</li>
<li>数据过期处理：LRU</li>
</ul>
<h4 id="1-1-Redis应用场景"><a href="#1-1-Redis应用场景" class="headerlink" title="1.1 Redis应用场景"></a>1.1 Redis应用场景</h4><p>Redis应用场景，面试中常被问到，“请问你在项目中哪些场景用到Redis，请举例说明。”</p>
<h5 id="1-1-1-内存数据库"><a href="#1-1-1-内存数据库" class="headerlink" title="1.1.1 内存数据库"></a>1.1.1 内存数据库</h5><p>登录信息、购物车信息、用户浏览记录等</p>
<h5 id="1-1-2-缓存数据库"><a href="#1-1-2-缓存数据库" class="headerlink" title="1.1.2 缓存数据库"></a>1.1.2 缓存数据库</h5><p>商品数据、广告数据</p>
<h5 id="1-1-3-Session共享"><a href="#1-1-3-Session共享" class="headerlink" title="1.1.3 Session共享"></a>1.1.3 Session共享</h5><p>解决分布式集群架构中的Session分离问题</p>
<h5 id="1-1-4-任务队列"><a href="#1-1-4-任务队列" class="headerlink" title="1.1.4 任务队列"></a>1.1.4 任务队列</h5><p>秒杀、抢购、12306购票</p>
<h5 id="1-1-5-消息发布订阅"><a href="#1-1-5-消息发布订阅" class="headerlink" title="1.1.5 消息发布订阅"></a>1.1.5 消息发布订阅</h5><p>支持发布订阅消息模式</p>
<h5 id="1-1-6-应用排行榜"><a href="#1-1-6-应用排行榜" class="headerlink" title="1.1.6 应用排行榜"></a>1.1.6 应用排行榜</h5><h5 id="1-1-7-网站访问统计"><a href="#1-1-7-网站访问统计" class="headerlink" title="1.1.7 网站访问统计"></a>1.1.7 网站访问统计</h5><h5 id="1-1-8-数据过期处理"><a href="#1-1-8-数据过期处理" class="headerlink" title="1.1.8 数据过期处理"></a>1.1.8 数据过期处理</h5><h5 id="1-1-9-分布式锁实现"><a href="#1-1-9-分布式锁实现" class="headerlink" title="1.1.9 分布式锁实现"></a>1.1.9 分布式锁实现</h5><h4 id="1-2-Redis单机安装"><a href="#1-2-Redis单机安装" class="headerlink" title="1.2 Redis单机安装"></a>1.2 Redis单机安装</h4><p><a href="https://redis.io" target="_blank" rel="noopener">Redis官方网站</a></p>
<h5 id="1-2-1-Redis安装包下载"><a href="#1-2-1-Redis安装包下载" class="headerlink" title="1.2.1 Redis安装包下载"></a>1.2.1 Redis安装包下载</h5><ul>
<li>官网下载最新版稳定安装包，如下图所示，当前最新版为5.0.5，关于Redis版本还需要结合公司开发业务场景决定，不必追求最新版本，毕竟生产环境严格要求系统的稳定性。<img src="E:\Architect\TechSnail\Redis\Redis核心知识梳理.assets\1568686851026.png" alt="1568686851026"></li>
</ul>
<h5 id="1-2-2-Redis安装环境"><a href="#1-2-2-Redis安装环境" class="headerlink" title="1.2.2 Redis安装环境"></a>1.2.2 Redis安装环境</h5><p>由于大多数企业服务器系统都是Linux，因此选择采用Linux环境安装，这里选择CentOS 7作为安装环境。</p>
<ul>
<li><p>第一步：安装C语言需要的GCC环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc-c++</span><br><span class="line">yum install -y wget</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>第二步：下载安装包或者windows环境下载后传到CentOS中，然后解压到安装路径</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.redis.io/releases/redis-5.0.5.tar.gz</span><br><span class="line">tar -zxvf redis-5.0.5.tar.gz -C /usr/apps(安装路径)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建软链接</span></span><br><span class="line">ln -s /usr/apps/redis-5.0.5 /usr/apps/redis</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三步：编译Redis源码，进入redis安装目录，执行编译命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/apps/redis</span><br><span class="line">make</span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要在/redis/src执行make install</span></span><br><span class="line">[root@localhost redis]# make install</span><br><span class="line">cd src &amp;&amp; make install</span><br><span class="line">make[1]: Entering directory `/usr/apps/redis-5.0.5/src'</span><br><span class="line">    CC Makefile.dep</span><br><span class="line">make[1]: Leaving directory `/usr/apps/redis-5.0.5/src'</span><br><span class="line">make[1]: Entering directory `/usr/apps/redis-5.0.5/src'</span><br><span class="line"></span><br><span class="line">Hint: It's a good idea to run 'make test' ;)</span><br><span class="line"></span><br><span class="line">    INSTALL install</span><br><span class="line">    INSTALL install</span><br><span class="line">    INSTALL install</span><br><span class="line">    INSTALL install</span><br><span class="line">    INSTALL install</span><br><span class="line">make[1]: Leaving directory `/usr/apps/redis-5.0.5/src'</span><br><span class="line">[root@localhost redis]# cd src </span><br><span class="line">[root@localhost src]# make install</span><br><span class="line"></span><br><span class="line">Hint: It's a good idea to run 'make test' ;)</span><br><span class="line"></span><br><span class="line">    INSTALL install</span><br><span class="line">    INSTALL install</span><br><span class="line">    INSTALL install</span><br><span class="line">    INSTALL install</span><br><span class="line">    INSTALL install</span><br><span class="line"><span class="meta">#</span><span class="bash"> 建议先进行make <span class="built_in">test</span></span></span><br><span class="line">[root@localhost src]# make test</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此时发现需要安装依赖包tcl</span></span><br><span class="line">You need tcl 8.5 or newer in order to run the Redis test</span><br><span class="line">make: *** [test] Error 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装tcl</span></span><br><span class="line">yum install tcl</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装Redis自定义路径下,安装后自定义路径下会新增bin目录，目录下包含如下文件，其中redis.conf需要从解压包中拷贝一份到bin目录</span></span><br><span class="line">redis-benchmark  # 性能测试工具</span><br><span class="line">redis-check-aof  # aof文件检查工具</span><br><span class="line">redis-check-rdb  # rdb文件检查工具</span><br><span class="line">redis-cli        # 进入redis命令客户端</span><br><span class="line">redis.conf       # redis配置文件</span><br><span class="line">redis-sentinel   # 启动哨兵监控服务</span><br><span class="line">redis-server     # 启动redis服务</span><br><span class="line"></span><br><span class="line">make install PREFIX=/usr/apps/redis</span><br></pre></td></tr></table></figure>
</li>
<li><p>第四步：</p>
<p>守护进程启动，需要修改redis.conf配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">vim redis.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将daemonize由no修改为yes</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="meta">#</span><span class="bash"> 注释掉<span class="built_in">bind</span>，默认绑定的是回环地址，不能被其他机器访问</span></span><br><span class="line">bind 127.0.0.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否开启保护模式，yes改为no</span></span><br><span class="line">protected-mode no</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改后 :wq保存文件</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 守护进程启动</span></span><br><span class="line">./bin/redis-server redis.conf start</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看redis是否正常启动</span></span><br><span class="line">[root@localhost bin]# lsof -i:6379</span><br><span class="line">COMMAND     PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">redis-ser 20124 root    6u  IPv6  58289      0t0  TCP *:6379 (LISTEN)</span><br><span class="line">redis-ser 20124 root    7u  IPv4  58290      0t0  TCP *:6379 (LISTEN)</span><br><span class="line"></span><br><span class="line">[root@localhost apps]# ps -ef | grep redis</span><br><span class="line">root     20124     1  0 03:14 ?        00:00:10 redis-server *:6379</span><br><span class="line">root     20832  3597  0 05:51 pts/0    00:00:00 grep --color=auto redis</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭redis</span></span><br><span class="line">./bin/redis-cli shutdown</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 小技巧， 配置环境变量，可以在任意路径启动redis</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"><span class="meta">#</span><span class="bash"> env config</span></span><br><span class="line">export REDIS_HOME=/usr/apps/redis</span><br><span class="line">export PATH=$REDIS_HOME/bin:$PATH</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改后</span></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
</li>
<li><p>第五步：</p>
<p>打开客户端</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./bin/redis-cli -h 192.168.1.10X -p 6379</span><br><span class="line">-h: #redis服务器ip地址</span><br><span class="line">-p: #redis实例的端口号</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="1-3-Redis基准测试"><a href="#1-3-Redis基准测试" class="headerlink" title="1.3 Redis基准测试"></a>1.3 Redis基准测试</h4><p>安装好单机版Redis，benchmark测试，复杂Redis命令QPS瞬间下滑</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-p160 bin]# redis-benchmark -h 192.168.1.160</span><br><span class="line">====== PING_INLINE ======</span><br><span class="line">  100000 requests completed in 2.79 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">59.22% &lt;= 1 milliseconds</span><br><span class="line">97.27% &lt;= 2 milliseconds</span><br><span class="line">99.04% &lt;= 3 milliseconds</span><br><span class="line">99.59% &lt;= 4 milliseconds</span><br><span class="line">99.75% &lt;= 5 milliseconds</span><br><span class="line">99.82% &lt;= 6 milliseconds</span><br><span class="line">99.82% &lt;= 7 milliseconds</span><br><span class="line">99.95% &lt;= 8 milliseconds</span><br><span class="line">100.00% &lt;= 8 milliseconds</span><br><span class="line">35893.75 requests per second</span><br><span class="line"></span><br><span class="line">====== PING_BULK ======</span><br><span class="line">  100000 requests completed in 2.55 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">67.92% &lt;= 1 milliseconds</span><br><span class="line">99.21% &lt;= 2 milliseconds</span><br><span class="line">99.63% &lt;= 3 milliseconds</span><br><span class="line">99.75% &lt;= 4 milliseconds</span><br><span class="line">99.87% &lt;= 5 milliseconds</span><br><span class="line">99.93% &lt;= 6 milliseconds</span><br><span class="line">100.00% &lt;= 7 milliseconds</span><br><span class="line">100.00% &lt;= 7 milliseconds</span><br><span class="line">39246.46 requests per second</span><br><span class="line"></span><br><span class="line">====== SET ======</span><br><span class="line">  100000 requests completed in 2.96 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">54.11% &lt;= 1 milliseconds</span><br><span class="line">95.99% &lt;= 2 milliseconds</span><br><span class="line">98.30% &lt;= 3 milliseconds</span><br><span class="line">99.39% &lt;= 4 milliseconds</span><br><span class="line">99.68% &lt;= 5 milliseconds</span><br><span class="line">99.86% &lt;= 6 milliseconds</span><br><span class="line">99.94% &lt;= 9 milliseconds</span><br><span class="line">99.99% &lt;= 23 milliseconds</span><br><span class="line">100.00% &lt;= 23 milliseconds</span><br><span class="line">33772.38 requests per second</span><br><span class="line"></span><br><span class="line">====== GET ======</span><br><span class="line">  100000 requests completed in 2.71 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">60.07% &lt;= 1 milliseconds</span><br><span class="line">98.15% &lt;= 2 milliseconds</span><br><span class="line">99.55% &lt;= 3 milliseconds</span><br><span class="line">99.75% &lt;= 4 milliseconds</span><br><span class="line">99.86% &lt;= 5 milliseconds</span><br><span class="line">99.94% &lt;= 6 milliseconds</span><br><span class="line">100.00% &lt;= 6 milliseconds</span><br><span class="line">36832.41 requests per second</span><br><span class="line"></span><br><span class="line">====== INCR ======</span><br><span class="line">  100000 requests completed in 3.11 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">52.16% &lt;= 1 milliseconds</span><br><span class="line">95.01% &lt;= 2 milliseconds</span><br><span class="line">97.53% &lt;= 3 milliseconds</span><br><span class="line">98.49% &lt;= 4 milliseconds</span><br><span class="line">99.09% &lt;= 5 milliseconds</span><br><span class="line">99.42% &lt;= 6 milliseconds</span><br><span class="line">99.62% &lt;= 7 milliseconds</span><br><span class="line">99.73% &lt;= 8 milliseconds</span><br><span class="line">99.89% &lt;= 9 milliseconds</span><br><span class="line">100.00% &lt;= 9 milliseconds</span><br><span class="line">32164.68 requests per second</span><br><span class="line"></span><br><span class="line">====== LPUSH ======</span><br><span class="line">  100000 requests completed in 2.71 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">56.81% &lt;= 1 milliseconds</span><br><span class="line">98.86% &lt;= 2 milliseconds</span><br><span class="line">99.70% &lt;= 3 milliseconds</span><br><span class="line">99.84% &lt;= 4 milliseconds</span><br><span class="line">99.95% &lt;= 5 milliseconds</span><br><span class="line">100.00% &lt;= 5 milliseconds</span><br><span class="line">36886.76 requests per second</span><br><span class="line"></span><br><span class="line">====== RPUSH ======</span><br><span class="line">  100000 requests completed in 2.91 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">56.98% &lt;= 1 milliseconds</span><br><span class="line">96.43% &lt;= 2 milliseconds</span><br><span class="line">98.67% &lt;= 3 milliseconds</span><br><span class="line">99.28% &lt;= 4 milliseconds</span><br><span class="line">99.47% &lt;= 5 milliseconds</span><br><span class="line">99.73% &lt;= 6 milliseconds</span><br><span class="line">99.88% &lt;= 8 milliseconds</span><br><span class="line">99.91% &lt;= 9 milliseconds</span><br><span class="line">99.91% &lt;= 10 milliseconds</span><br><span class="line">99.94% &lt;= 11 milliseconds</span><br><span class="line">99.94% &lt;= 14 milliseconds</span><br><span class="line">99.95% &lt;= 28 milliseconds</span><br><span class="line">100.00% &lt;= 28 milliseconds</span><br><span class="line">34376.07 requests per second</span><br><span class="line"></span><br><span class="line">====== LPOP ======</span><br><span class="line">  100000 requests completed in 2.77 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">55.57% &lt;= 1 milliseconds</span><br><span class="line">98.26% &lt;= 2 milliseconds</span><br><span class="line">99.50% &lt;= 3 milliseconds</span><br><span class="line">99.77% &lt;= 4 milliseconds</span><br><span class="line">99.90% &lt;= 5 milliseconds</span><br><span class="line">99.97% &lt;= 6 milliseconds</span><br><span class="line">100.00% &lt;= 7 milliseconds</span><br><span class="line">100.00% &lt;= 7 milliseconds</span><br><span class="line">36153.29 requests per second</span><br><span class="line"></span><br><span class="line">====== RPOP ======</span><br><span class="line">  100000 requests completed in 2.95 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">55.48% &lt;= 1 milliseconds</span><br><span class="line">96.17% &lt;= 2 milliseconds</span><br><span class="line">98.37% &lt;= 3 milliseconds</span><br><span class="line">99.05% &lt;= 4 milliseconds</span><br><span class="line">99.42% &lt;= 5 milliseconds</span><br><span class="line">99.65% &lt;= 6 milliseconds</span><br><span class="line">99.80% &lt;= 7 milliseconds</span><br><span class="line">99.81% &lt;= 9 milliseconds</span><br><span class="line">99.85% &lt;= 10 milliseconds</span><br><span class="line">99.87% &lt;= 11 milliseconds</span><br><span class="line">99.92% &lt;= 12 milliseconds</span><br><span class="line">99.98% &lt;= 13 milliseconds</span><br><span class="line">99.99% &lt;= 23 milliseconds</span><br><span class="line">100.00% &lt;= 23 milliseconds</span><br><span class="line">33944.33 requests per second</span><br><span class="line"></span><br><span class="line">====== SADD ======</span><br><span class="line">  100000 requests completed in 2.73 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">59.64% &lt;= 1 milliseconds</span><br><span class="line">97.82% &lt;= 2 milliseconds</span><br><span class="line">99.36% &lt;= 3 milliseconds</span><br><span class="line">99.71% &lt;= 4 milliseconds</span><br><span class="line">99.78% &lt;= 5 milliseconds</span><br><span class="line">99.88% &lt;= 6 milliseconds</span><br><span class="line">99.92% &lt;= 7 milliseconds</span><br><span class="line">99.93% &lt;= 8 milliseconds</span><br><span class="line">99.98% &lt;= 10 milliseconds</span><br><span class="line">99.99% &lt;= 11 milliseconds</span><br><span class="line">100.00% &lt;= 11 milliseconds</span><br><span class="line">36643.46 requests per second</span><br><span class="line"></span><br><span class="line">====== HSET ======</span><br><span class="line">  100000 requests completed in 2.80 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">55.56% &lt;= 1 milliseconds</span><br><span class="line">97.49% &lt;= 2 milliseconds</span><br><span class="line">98.96% &lt;= 3 milliseconds</span><br><span class="line">99.58% &lt;= 4 milliseconds</span><br><span class="line">99.85% &lt;= 5 milliseconds</span><br><span class="line">99.97% &lt;= 6 milliseconds</span><br><span class="line">99.97% &lt;= 7 milliseconds</span><br><span class="line">100.00% &lt;= 7 milliseconds</span><br><span class="line">35714.29 requests per second</span><br><span class="line"></span><br><span class="line">====== SPOP ======</span><br><span class="line">  100000 requests completed in 2.69 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">63.08% &lt;= 1 milliseconds</span><br><span class="line">97.82% &lt;= 2 milliseconds</span><br><span class="line">99.39% &lt;= 3 milliseconds</span><br><span class="line">99.69% &lt;= 4 milliseconds</span><br><span class="line">99.70% &lt;= 5 milliseconds</span><br><span class="line">99.82% &lt;= 6 milliseconds</span><br><span class="line">99.89% &lt;= 7 milliseconds</span><br><span class="line">99.90% &lt;= 9 milliseconds</span><br><span class="line">99.95% &lt;= 10 milliseconds</span><br><span class="line">100.00% &lt;= 10 milliseconds</span><br><span class="line">37119.52 requests per second</span><br><span class="line"></span><br><span class="line">====== LPUSH (needed to benchmark LRANGE) ======</span><br><span class="line">  100000 requests completed in 2.76 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">57.28% &lt;= 1 milliseconds</span><br><span class="line">97.95% &lt;= 2 milliseconds</span><br><span class="line">99.27% &lt;= 3 milliseconds</span><br><span class="line">99.54% &lt;= 4 milliseconds</span><br><span class="line">99.72% &lt;= 5 milliseconds</span><br><span class="line">99.93% &lt;= 6 milliseconds</span><br><span class="line">99.98% &lt;= 9 milliseconds</span><br><span class="line">100.00% &lt;= 9 milliseconds</span><br><span class="line">36258.16 requests per second</span><br><span class="line"></span><br><span class="line">====== LRANGE_100 (first 100 elements) ======</span><br><span class="line">  100000 requests completed in 7.34 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">0.34% &lt;= 1 milliseconds</span><br><span class="line">14.99% &lt;= 2 milliseconds</span><br><span class="line">67.96% &lt;= 3 milliseconds</span><br><span class="line">95.18% &lt;= 4 milliseconds</span><br><span class="line">98.26% &lt;= 5 milliseconds</span><br><span class="line">99.11% &lt;= 6 milliseconds</span><br><span class="line">99.48% &lt;= 7 milliseconds</span><br><span class="line">99.64% &lt;= 8 milliseconds</span><br><span class="line">99.81% &lt;= 9 milliseconds</span><br><span class="line">99.87% &lt;= 10 milliseconds</span><br><span class="line">99.91% &lt;= 11 milliseconds</span><br><span class="line">99.92% &lt;= 12 milliseconds</span><br><span class="line">99.92% &lt;= 13 milliseconds</span><br><span class="line">99.95% &lt;= 14 milliseconds</span><br><span class="line">99.97% &lt;= 15 milliseconds</span><br><span class="line">99.99% &lt;= 16 milliseconds</span><br><span class="line">100.00% &lt;= 16 milliseconds</span><br><span class="line">13631.41 requests per second</span><br><span class="line"></span><br><span class="line">====== LRANGE_300 (first 300 elements) ======</span><br><span class="line">  100000 requests completed in 17.18 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">0.00% &lt;= 1 milliseconds</span><br><span class="line">0.11% &lt;= 2 milliseconds</span><br><span class="line">1.32% &lt;= 3 milliseconds</span><br><span class="line">5.11% &lt;= 4 milliseconds</span><br><span class="line">22.57% &lt;= 5 milliseconds</span><br><span class="line">45.09% &lt;= 6 milliseconds</span><br><span class="line">67.23% &lt;= 7 milliseconds</span><br><span class="line">86.20% &lt;= 8 milliseconds</span><br><span class="line">94.58% &lt;= 9 milliseconds</span><br><span class="line">97.06% &lt;= 10 milliseconds</span><br><span class="line">98.06% &lt;= 11 milliseconds</span><br><span class="line">98.64% &lt;= 12 milliseconds</span><br><span class="line">99.02% &lt;= 13 milliseconds</span><br><span class="line">99.30% &lt;= 14 milliseconds</span><br><span class="line">99.48% &lt;= 15 milliseconds</span><br><span class="line">99.62% &lt;= 16 milliseconds</span><br><span class="line">99.74% &lt;= 17 milliseconds</span><br><span class="line">99.82% &lt;= 18 milliseconds</span><br><span class="line">99.86% &lt;= 19 milliseconds</span><br><span class="line">99.90% &lt;= 20 milliseconds</span><br><span class="line">99.90% &lt;= 21 milliseconds</span><br><span class="line">99.92% &lt;= 22 milliseconds</span><br><span class="line">99.94% &lt;= 23 milliseconds</span><br><span class="line">99.97% &lt;= 24 milliseconds</span><br><span class="line">99.97% &lt;= 29 milliseconds</span><br><span class="line">99.99% &lt;= 35 milliseconds</span><br><span class="line">99.99% &lt;= 39 milliseconds</span><br><span class="line">100.00% &lt;= 40 milliseconds</span><br><span class="line">100.00% &lt;= 40 milliseconds</span><br><span class="line">5821.40 requests per second</span><br><span class="line"></span><br><span class="line">====== LRANGE_500 (first 450 elements) ======</span><br><span class="line">  100000 requests completed in 23.98 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">0.00% &lt;= 1 milliseconds</span><br><span class="line">0.00% &lt;= 2 milliseconds</span><br><span class="line">0.09% &lt;= 3 milliseconds</span><br><span class="line">0.88% &lt;= 4 milliseconds</span><br><span class="line">3.03% &lt;= 5 milliseconds</span><br><span class="line">8.62% &lt;= 6 milliseconds</span><br><span class="line">22.30% &lt;= 7 milliseconds</span><br><span class="line">38.27% &lt;= 8 milliseconds</span><br><span class="line">54.54% &lt;= 9 milliseconds</span><br><span class="line">70.24% &lt;= 10 milliseconds</span><br><span class="line">83.97% &lt;= 11 milliseconds</span><br><span class="line">92.72% &lt;= 12 milliseconds</span><br><span class="line">96.17% &lt;= 13 milliseconds</span><br><span class="line">97.54% &lt;= 14 milliseconds</span><br><span class="line">98.28% &lt;= 15 milliseconds</span><br><span class="line">98.74% &lt;= 16 milliseconds</span><br><span class="line">99.05% &lt;= 17 milliseconds</span><br><span class="line">99.27% &lt;= 18 milliseconds</span><br><span class="line">99.44% &lt;= 19 milliseconds</span><br><span class="line">99.55% &lt;= 20 milliseconds</span><br><span class="line">99.61% &lt;= 21 milliseconds</span><br><span class="line">99.65% &lt;= 22 milliseconds</span><br><span class="line">99.71% &lt;= 23 milliseconds</span><br><span class="line">99.76% &lt;= 24 milliseconds</span><br><span class="line">99.82% &lt;= 25 milliseconds</span><br><span class="line">99.86% &lt;= 26 milliseconds</span><br><span class="line">99.90% &lt;= 27 milliseconds</span><br><span class="line">99.93% &lt;= 28 milliseconds</span><br><span class="line">99.94% &lt;= 29 milliseconds</span><br><span class="line">99.95% &lt;= 36 milliseconds</span><br><span class="line">99.96% &lt;= 37 milliseconds</span><br><span class="line">99.97% &lt;= 38 milliseconds</span><br><span class="line">99.98% &lt;= 39 milliseconds</span><br><span class="line">99.99% &lt;= 40 milliseconds</span><br><span class="line">100.00% &lt;= 41 milliseconds</span><br><span class="line">100.00% &lt;= 41 milliseconds</span><br><span class="line">4169.97 requests per second</span><br><span class="line"></span><br><span class="line">====== LRANGE_600 (first 600 elements) ======</span><br><span class="line">  100000 requests completed in 30.68 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">0.00% &lt;= 2 milliseconds</span><br><span class="line">0.01% &lt;= 3 milliseconds</span><br><span class="line">0.13% &lt;= 4 milliseconds</span><br><span class="line">0.58% &lt;= 5 milliseconds</span><br><span class="line">1.99% &lt;= 6 milliseconds</span><br><span class="line">4.64% &lt;= 7 milliseconds</span><br><span class="line">11.23% &lt;= 8 milliseconds</span><br><span class="line">22.54% &lt;= 9 milliseconds</span><br><span class="line">35.08% &lt;= 10 milliseconds</span><br><span class="line">47.90% &lt;= 11 milliseconds</span><br><span class="line">60.37% &lt;= 12 milliseconds</span><br><span class="line">72.43% &lt;= 13 milliseconds</span><br><span class="line">83.20% &lt;= 14 milliseconds</span><br><span class="line">91.29% &lt;= 15 milliseconds</span><br><span class="line">95.15% &lt;= 16 milliseconds</span><br><span class="line">96.71% &lt;= 17 milliseconds</span><br><span class="line">97.53% &lt;= 18 milliseconds</span><br><span class="line">98.13% &lt;= 19 milliseconds</span><br><span class="line">98.57% &lt;= 20 milliseconds</span><br><span class="line">98.94% &lt;= 21 milliseconds</span><br><span class="line">99.19% &lt;= 22 milliseconds</span><br><span class="line">99.38% &lt;= 23 milliseconds</span><br><span class="line">99.50% &lt;= 24 milliseconds</span><br><span class="line">99.60% &lt;= 25 milliseconds</span><br><span class="line">99.67% &lt;= 26 milliseconds</span><br><span class="line">99.73% &lt;= 27 milliseconds</span><br><span class="line">99.79% &lt;= 28 milliseconds</span><br><span class="line">99.84% &lt;= 29 milliseconds</span><br><span class="line">99.87% &lt;= 30 milliseconds</span><br><span class="line">99.89% &lt;= 31 milliseconds</span><br><span class="line">99.90% &lt;= 32 milliseconds</span><br><span class="line">99.93% &lt;= 33 milliseconds</span><br><span class="line">99.96% &lt;= 34 milliseconds</span><br><span class="line">99.97% &lt;= 35 milliseconds</span><br><span class="line">99.98% &lt;= 36 milliseconds</span><br><span class="line">99.99% &lt;= 38 milliseconds</span><br><span class="line">99.99% &lt;= 39 milliseconds</span><br><span class="line">99.99% &lt;= 41 milliseconds</span><br><span class="line">99.99% &lt;= 43 milliseconds</span><br><span class="line">100.00% &lt;= 44 milliseconds</span><br><span class="line">100.00% &lt;= 44 milliseconds</span><br><span class="line">3259.56 requests per second</span><br><span class="line"></span><br><span class="line">====== MSET (10 keys) ======</span><br><span class="line">  100000 requests completed in 3.53 seconds</span><br><span class="line">  50 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line"></span><br><span class="line">7.59% &lt;= 1 milliseconds</span><br><span class="line">95.91% &lt;= 2 milliseconds</span><br><span class="line">99.44% &lt;= 3 milliseconds</span><br><span class="line">99.66% &lt;= 4 milliseconds</span><br><span class="line">99.79% &lt;= 5 milliseconds</span><br><span class="line">99.83% &lt;= 6 milliseconds</span><br><span class="line">99.90% &lt;= 7 milliseconds</span><br><span class="line">99.91% &lt;= 8 milliseconds</span><br><span class="line">99.94% &lt;= 9 milliseconds</span><br><span class="line">99.99% &lt;= 10 milliseconds</span><br><span class="line">100.00% &lt;= 10 milliseconds</span><br><span class="line">28304.56 requests per second</span><br></pre></td></tr></table></figure>
<h3 id="2-Redis数据类型"><a href="#2-Redis数据类型" class="headerlink" title="2 Redis数据类型"></a>2 Redis数据类型</h3><p><a href="http://www.redis.cn/commands.html" target="_blank" rel="noopener">Redis命令大全</a></p>
<blockquote>
<p>Redis官网提供最全的命令，详细介绍命令语法，时间复杂度，注意事项，应用场景等等，需要耐心学习验证。同时学习命令的同时结合Java客户端如Jedis接口进行实践，记忆会更加深刻，提高实战能力。</p>
</blockquote>
<p>说明： </p>
<p>a. Redis的键值设计非常关键，比如说键值可以用于区分业务类型。</p>
<ul>
<li>Key要见名知义，类似数据库表名称</li>
<li>Key要辅助查找</li>
<li>Key设计需要避免重复，因为Redis赋值，Key重复将会覆盖之前数据</li>
</ul>
<p>b. Redis 命令行忽略大小写，但是键值key不忽略大小写。</p>
<p>c. Redis大多数命令时间复杂度：O(1)，具体问题具体分析，如遇到遍历相关的操作，时间复杂度另当别论。</p>
<h4 id="2-1-String"><a href="#2-1-String" class="headerlink" title="2.1 String"></a>2.1 String</h4><h5 id="SET-key-value-EX-seconds-PX-milliseconds-NX-XX"><a href="#SET-key-value-EX-seconds-PX-milliseconds-NX-XX" class="headerlink" title="SET key value [EX seconds] [PX milliseconds] [NX|XX]"></a>SET key value [EX seconds] [PX milliseconds] [NX|XX]</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SET key value [EX seconds] [PX milliseconds] [NX|XX]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 命令时间复杂度：O(1)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> EX seconds      – 设置键key的过期时间，单位时秒</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> PX milliseconds – 设置键key的过期时间，单位时毫秒</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> NX              – 只有键key不存在的时候才会设置key的值</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> XX              – 只有键key存在的时候才会设置key的值</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意: 由于SET命令加上选项已经可以完全取代SETNX, SETEX, PSETEX的功能，所以在将来的版本中，redis可能会不推荐使用并且最终抛弃这几个命令。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 返回值</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果SET命令正常执行那么回返回OK，否则如果加了NX 或者 XX选项，但是没有设置条件。那么会返回nil。</span></span><br></pre></td></tr></table></figure>
<p>命令 <code>SET resource-name anystring NX EX max-lock-time</code> 是一种用 Redis 来实现锁机制的简单方法。</p>
<p>如果上述命令返回<code>OK</code>，那么客户端就可以获得锁（如果上述命令返回Nil，那么客户端可以在一段时间之后重新尝试），并且可以通过<a href="http://www.redis.cn/commands/del.html" target="_blank" rel="noopener">DEL</a>命令来释放锁。</p>
<p>客户端加锁之后，如果没有主动释放，会在过期时间之后自动释放。</p>
<p>可以通过如下优化使得上面的锁系统变得更加鲁棒：</p>
<ul>
<li>不要设置固定的字符串，而是设置为随机的大字符串，可以称为token。</li>
<li>通过脚步删除指定锁的key，而不是<a href="http://www.redis.cn/commands/del.html" target="_blank" rel="noopener">DEL</a>命令。</li>
</ul>
<p>上述优化方法会避免下述场景：</p>
<p>a客户端获得的锁（键key）已经由于过期时间到了被redis服务器删除，但是这个时候a客户端还去执行<a href="http://www.redis.cn/commands/del.html" target="_blank" rel="noopener">DEL</a>命令。而b客户端已经在a设置的过期时间之后重新获取了这个同样key的锁，那么a执行<a href="http://www.redis.cn/commands/del.html" target="_blank" rel="noopener">DEL</a>就会释放了b客户端加好的锁。</p>
<p>解锁脚本的一个例子将类似于以下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.call(<span class="string">"get"</span>,KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> redis.call(<span class="string">"del"</span>,KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h4 id="2-2-Hash"><a href="#2-2-Hash" class="headerlink" title="2.2 Hash"></a>2.2 Hash</h4><h4 id="2-3-List"><a href="#2-3-List" class="headerlink" title="2.3 List"></a>2.3 List</h4><h4 id="2-4-Set"><a href="#2-4-Set" class="headerlink" title="2.4 Set"></a>2.4 Set</h4><h4 id="2-5-SortedSet"><a href="#2-5-SortedSet" class="headerlink" title="2.5 SortedSet"></a>2.5 SortedSet</h4><h3 id="3-Redis-事务"><a href="#3-Redis-事务" class="headerlink" title="3 Redis 事务"></a>3 Redis 事务</h3><h4 id="3-1-Redis事务介绍"><a href="#3-1-Redis事务介绍" class="headerlink" title="3.1 Redis事务介绍"></a>3.1 Redis事务介绍</h4><ul>
<li><p>Redis事务通过MULTI、EXEC、DISCARD和WATCH这四个命令实现</p>
</li>
<li><p>Redis单个命令都是原子性的，因此需要确保事务性的对象是命令集合</p>
</li>
<li><p>Redis将命令集合序列化并确保处于同一事务的命令集合连续且不被打断执行</p>
</li>
<li><p>Redis不支持回滚操作</p>
<p>如何理解呢？</p>
<ul>
<li>大多数事务失败是因为语法错误或者类型错误，这两种错误，在开发阶段都是可以预见的</li>
<li>Redis为了性能方面就忽略了事务回滚</li>
</ul>
</li>
</ul>
<h5 id="3-1-1-MULTI"><a href="#3-1-1-MULTI" class="headerlink" title="3.1.1 MULTI"></a>3.1.1 MULTI</h5><p>用于标记事务块的开始，Redis会将后续的命令诸葛放入队列中，然后使用EXEC命令原子化地执行该命令序列。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">multi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试，将同一个事务的redis命令加入队列</span></span><br><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set a 1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; set b 2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; set c 3</span><br><span class="line">QUEUED</span><br></pre></td></tr></table></figure>
<h5 id="3-1-2-EXEC"><a href="#3-1-2-EXEC" class="headerlink" title="3.1.2 EXEC"></a>3.1.2 EXEC</h5><p>在一个事务中执行所有先前放入队列的命令，然后恢复正常连接状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">exec</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试，执行队列中的redis命令</span></span><br><span class="line">127.0.0.1:6379&gt; EXEC</span><br><span class="line">1) OK</span><br><span class="line">2) OK</span><br><span class="line">3) OK</span><br></pre></td></tr></table></figure>
<h5 id="3-1-3-DISCARD"><a href="#3-1-3-DISCARD" class="headerlink" title="3.1.3 DISCARD"></a>3.1.3 DISCARD</h5><p>清除所有先前在一个事务中放入队列的命令，然后恢复正常的连接状态。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">discard</span><br></pre></td></tr></table></figure>
<h5 id="3-1-4-WATCH"><a href="#3-1-4-WATCH" class="headerlink" title="3.1.4 WATCH"></a>3.1.4 WATCH</h5><p>当某个事务需要按照条件执行时，就要使用这个命令将给定的键设置为受监控的状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用该命令可以实现redis乐观锁</span></span><br><span class="line">watch key [key ...]</span><br></pre></td></tr></table></figure>
<h5 id="3-1-5-UNWATCH"><a href="#3-1-5-UNWATCH" class="headerlink" title="3.1.5 UNWATCH"></a>3.1.5 UNWATCH</h5><p>清除所有先前为一个事务监控的键</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unwatch</span><br></pre></td></tr></table></figure>
<h3 id="4-Redis持久化"><a href="#4-Redis持久化" class="headerlink" title="4 Redis持久化"></a>4 Redis持久化</h3><p>Redis持久化是因为Redis为内存数据库，内存中的数据无法应对灾难性的故障，如生产环境系统宕机、机房毁坏或停电、电缆施工过程毁坏等，会导致大型的故障和Case。为了应对灾难，必须有持久化和备份恢复的方案。如将持久化文件备份到云存储服务器上，如果灾难发生，同步到本地进行数据恢复，就能扛过一次灾难。</p>
<p>Redis持久化方式两种：</p>
<ul>
<li><p>RDB（Redis默认持久化方式）</p>
<p>优点：通过存储数据快照文件，恢复数据便捷</p>
<p>缺点：RDB模式会丢失最后一次快照以后更改的所有数据</p>
</li>
<li><p>AOF</p>
</li>
</ul>
<blockquote>
<p>注意： 两种持久化方式可以单独使用，亦可结合使用，当同时存在两种持久化方式时，优先使用AOF</p>
</blockquote>
<h4 id="4-1-Redis持久化之RDB"><a href="#4-1-Redis持久化之RDB" class="headerlink" title="4.1 Redis持久化之RDB"></a>4.1 Redis持久化之RDB</h4><p>​        RDB持久化是通过快照完成，当符合一定条件时，redis会自动将内存中全部数据执行快照操作，并存储到硬盘。默认存储在dump.rdb文件（文件名在redis.conf文件中dbfilename）</p>
<p>Redis进行快照的时机，配置文件redis.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">save 900 1      # 表示900秒内至少1个键被更改则进行快照。  </span><br><span class="line">save 300 10     # 表示300秒内至少10条被更改则快照  </span><br><span class="line">save 60  10000  # 表示60秒内至少10000条</span><br></pre></td></tr></table></figure>
<p>Redis自动实现快照过程：</p>
<ul>
<li>Redis使用fork函数复制一份当前进程的副本（子进程）；</li>
<li>父进程继续接收并处理客户端发来的命令，而子进程开始将内存中的数据写入硬盘中的临时文件；</li>
<li>当子进程写入完所有数据后会用该临时文件替换旧的RDB文件，至此，一次快照操作完成。</li>
</ul>
<p>注意：Redis在进行快照的过程中不会修改RDB文件，只有快照结束后才将旧的文件替换为新的，因此任何时候RDB文件都是完整的。该模式使得我们可以通过定时备份RDB文件来实现Redis数据库备份。</p>
<p>RDB文件经过压缩的二进制文件，占用空间小于内存中的数据，便于传输。</p>
<p>手动测试RDB：</p>
<p>rdb文件会保持在dir参数对应的路径下。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 主进程进行快照，会阻塞其他请求</span></span><br><span class="line">save</span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis执行fork函数复制出一个子进程进行快照操作</span></span><br><span class="line">bgsave</span><br></pre></td></tr></table></figure>
<p>检测并修复rdb文件？</p>
<p>redis-check-dump</p>
<p>知识点：</p>
<ul>
<li>redis-cli shutdown命令关闭redis，redis会生成完整的数据快照存到dump.rdb文件，属于安全关闭。</li>
<li>模拟redis故障退出，kill -9 redis进程id，内存数据丢失</li>
</ul>
<h4 id="4-2-Redis持久化之AOF"><a href="#4-2-Redis持久化之AOF" class="headerlink" title="4.2 Redis持久化之AOF"></a>4.2 Redis持久化之AOF</h4><p>AOF方式是通过日志文件进行持久化。默认情况下Redis未开启AOF，可以通过修改redis.conf配置文件的appendonly参数开启。</p>
<p>aof文件会保持在dir参数对应的路径下。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">appendonly yes</span><br></pre></td></tr></table></figure>
<p>默认文件名appendonly.aof，可以通过修改redis.conf参数appendfilename重命名。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">appendfilename appendonly.aof</span><br></pre></td></tr></table></figure>
<p>Redis写命令的同步时机：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">appendfsync always    # 每次都会执行，性能差  </span><br><span class="line">appendfsync everysec  # 默认 每秒执行一次同步操作（推荐，默认）  </span><br><span class="line">appendfsync no        # 不主动进行同步，由操作系统来做，30秒一次</span><br></pre></td></tr></table></figure>
<p>AOF日志文件重写：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 当前aof文件大小超过上一次重写时的aof文件大小的百分之多少时会再次进行重写，如果之前没有重写，则以启动时的aof文件大小为依据</span></span><br><span class="line"></span><br><span class="line">auto-aof-rewrite-percentage 100 </span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br></pre></td></tr></table></figure>
<p>手动测试AOF</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 重写过程只和内存中的数据有关，和之前aof文件无关</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 所谓重写，不需要对原有aof文件进行任何读写，它针对的是数据库中key的当前值</span></span><br><span class="line">bgrewriteaof</span><br></pre></td></tr></table></figure>
<p>检测并修复aof文件？</p>
<p>redis-check-aof</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 修复损坏的AOF文件</span></span><br><span class="line">redis-check-aof --fix</span><br></pre></td></tr></table></figure>
<p>动态切换redis持久方式，从 RDB 切换到 AOF（支持Redis 2.2及以上）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CONFIG SET appendonly yes</span><br><span class="line"></span><br><span class="line">CONFIG SET save "" （可选）</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ul>
<li><p>当redis启动时，如果rdb持久化和aof持久化都打开，那么程序会优先使用aof方式来恢复数据集，因为aof方式所保存的数据通常是最完整的。如果aof文件丢失，则启动之后数据库内容为空。</p>
</li>
<li><p>如果想把正在运行的redis数据库，从RDB切换到AOF，建议先使用动态切换方式，再修改配置文件，重启数据库。(不能自己修改配置文件，重启数据库，否则数据库中数据就为空了，问题出在redis在开启aof后就会默认使用aof，因为此时aof文件为空。)</p>
</li>
<li><p>如果RDB执行snapshotting操作，redis不会执行AOF rewrite操作；如果redis在执行AOF rewrite操作，那么不会执行RDB snapshotting操作</p>
</li>
<li>如果RDB执行snapshotting操作，此时用户执行BGREWRITEAOF命令，那么需要等RDB快照生成之后才能执行AOF rewrite操作。</li>
</ul>
<h4 id="4-3-企业级数据备份方案"><a href="#4-3-企业级数据备份方案" class="headerlink" title="4.3 企业级数据备份方案"></a>4.3 企业级数据备份方案</h4><p>RDB方案适合数据冷备方案：</p>
<ul>
<li>写crontab定时调度脚本做数据备份；</li>
<li>每小时copy一份RBD文件，备份到一个目录，保留最近48小时的数据备份；</li>
<li>每天都保留一份RDB文件，备份到一个目录，仅仅保留最近一个月的备份；</li>
<li>每次copy备份的时候，将过旧的备份文件删除；</li>
<li>每天晚上将当前服务器上所有数据备份，发送一份至远程的云端服务器。</li>
</ul>
<p>冷备方案实践一下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每小时copy一次备份，删除48小时前的数据</span></span><br><span class="line"></span><br><span class="line">crontab -e</span><br><span class="line"></span><br><span class="line">0 * * * * sh /usr/<span class="built_in">local</span>/redis/copy/redis_rdb_copy_hourly.sh</span><br><span class="line"></span><br><span class="line">redis_rdb_copy_hourly.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/sh </span></span><br><span class="line"></span><br><span class="line">cur_date=`date +%Y%m%d%k`</span><br><span class="line">rm -rf /usr/<span class="built_in">local</span>/redis/snapshotting/<span class="variable">$cur_date</span></span><br><span class="line">mkdir /usr/<span class="built_in">local</span>/redis/snapshotting/<span class="variable">$cur_date</span></span><br><span class="line">cp /var/redis/6379/dump.rdb /usr/<span class="built_in">local</span>/redis/snapshotting/<span class="variable">$cur_date</span></span><br><span class="line"></span><br><span class="line">del_date=`date -d -48hour +%Y%m%d%k`</span><br><span class="line">rm -rf /usr/<span class="built_in">local</span>/redis/snapshotting/<span class="variable">$del_date</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 每天copy一次备份</span></span><br><span class="line"></span><br><span class="line">crontab -e</span><br><span class="line"></span><br><span class="line">0 0 * * * sh /usr/<span class="built_in">local</span>/redis/copy/redis_rdb_copy_daily.sh</span><br><span class="line"></span><br><span class="line">redis_rdb_copy_daily.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/sh </span></span><br><span class="line"></span><br><span class="line">cur_date=`date +%Y%m%d`</span><br><span class="line">rm -rf /usr/<span class="built_in">local</span>/redis/snapshotting/<span class="variable">$cur_date</span></span><br><span class="line">mkdir /usr/<span class="built_in">local</span>/redis/snapshotting/<span class="variable">$cur_date</span></span><br><span class="line">cp /var/redis/6379/dump.rdb /usr/<span class="built_in">local</span>/redis/snapshotting/<span class="variable">$cur_date</span></span><br><span class="line"></span><br><span class="line">del_date=`date -d -1month +%Y%m%d`</span><br><span class="line">rm -rf /usr/<span class="built_in">local</span>/redis/snapshotting/<span class="variable">$del_date</span></span><br></pre></td></tr></table></figure>
<p>RDB冷备方案故障恢复：</p>
<p>如果数据误删后，需要通过rdb文件进行恢复，需要注意一下，生产环境一般都会开启aof，此时redis优先使用aof加载数据，所以需要先将aof关闭，redis才能使用rdb备份文件恢复数据，此时一定要注意，需要通过CONFIG SET热修改appendonly yes，再次执行config rewrite将热修改重新写入配置文件，此时会根据恢复后的数据生成aof文件。</p>
<h3 id="5-Redis常用命令"><a href="#5-Redis常用命令" class="headerlink" title="5 Redis常用命令"></a>5 Redis常用命令</h3><p>参考博客：</p>
<p><a href="https://www.cnblogs.com/tianciliangen/p/7942560.html" target="_blank" rel="noopener">Redis特性及应用场景总结</a></p>
<h4 id="5-1-config命令"><a href="#5-1-config命令" class="headerlink" title="5.1 config命令"></a>5.1 config命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 动态设置参数，服务器重启后失效</span></span><br><span class="line">config set</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 举例</span></span><br><span class="line">config set appendonly yes</span><br><span class="line">config set save "90 1 30 10 60 100"</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看所有可以用config <span class="built_in">set</span>命令设置的参数</span></span><br><span class="line">config get *</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Redis服务器启动后，config rewrite命令修改配置文件redis.conf（Redis 2.8及以上版本可以使用），主要是将config <span class="built_in">set</span>动态指定的命令保存到配置文件中。</span></span><br><span class="line">config rewrite</span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意：config rewrite 命令对redis.conf文件的重写是原子性的，并且是一致的：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果重写出错或重写期间服务器崩溃，那么重写失败，原有redis.conf文件不会被修改；如果重写成功，那么redis.conf文件为重写后的新文件</span></span><br></pre></td></tr></table></figure>
<h4 id="5-2-安全策略"><a href="#5-2-安全策略" class="headerlink" title="5.2 安全策略"></a>5.2 安全策略</h4><p>设置数据库密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 修改密码</span></span><br><span class="line">requirepass password</span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证密码</span></span><br><span class="line">auth password</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">bind</span>参数（数据库只能在指定IP下访问）</span></span><br><span class="line">bind 127.0.0.1</span><br></pre></td></tr></table></figure>
<h4 id="5-3-命令重命名"><a href="#5-3-命令重命名" class="headerlink" title="5.3 命令重命名"></a>5.3 命令重命名</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 修改命令的名称</span></span><br><span class="line">rename-command flushall cleanall</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用命令</span></span><br><span class="line">rename-command flushall ""</span><br></pre></td></tr></table></figure>
<h3 id="6-Redis主从复制"><a href="#6-Redis主从复制" class="headerlink" title="6 Redis主从复制"></a>6 Redis主从复制</h3><h4 id="6-1-Redis高并发企业实践"><a href="#6-1-Redis高并发企业实践" class="headerlink" title="6.1 Redis高并发企业实践"></a>6.1 Redis高并发企业实践</h4><ul>
<li><p>Redis主从架构</p>
<p>QPS量级决定Redis高并发方案，单机Redis支持QPS 1W+，如果业务场景超过10W+并发，单机Redis无法承受到达瓶颈。首先想到读写分离，一般情况下业务场景都是读多写少。Redis主从架构，一主多从，主节点负责写请求，从节点负责读请求。支持水平扩容，读请求逐渐增加，我们可以直接通过添加从节点方式解决。（Redis主从架构解决读高并发问题，如果是写高并发需要异步方案）</p>
<ul>
<li><p>主从复制原理：master -&gt; slave复制数据</p>
<ul>
<li>异步方式复制数据到slave节点，redis2.8版本开始，slave node会周期性的确认自己每次复制的数据量</li>
<li>一个master node可以配置多个slave node</li>
<li>slave node 可以连接其他slave node</li>
<li>slave node做复制的时候，是不会block master node的正常工作</li>
<li>slave node做复制时，不会block对自己的查询操作，会用旧的数据集提供服务，复制完成时，需要删除旧的数据，并加载新数据，此时会暂停对外服务</li>
<li>slave node主要用于水平扩容，做读写分离，扩容的slave node可以提高读的吞吐量</li>
</ul>
</li>
<li><p>master持久化对于主从架构安全保障意义</p>
<p>如果采用主从架构，建议必须开启master node持久化</p>
</li>
<li><p>主从架构原理描述</p>
<ul>
<li>slave ping master</li>
<li>full resynchronization命令，slave 全量复制</li>
<li>master收到slave全量复制请求后，根据最新数据生成rdb文件发送给slave，slave将rdb持久化到磁盘，然后加载到slave内存中</li>
<li>master全量复制后，继续同步后续的数据给slave，异步复制的方式</li>
<li>支持断点续传，master和slave保存replica offset</li>
<li>无磁盘化复制 repl-diskless-sync yes</li>
<li>过期key处理，slave不会过期key，需要同步master过期key操作</li>
</ul>
</li>
<li><p>复制完整流程</p>
<ul>
<li>slave node启动，仅仅保存master node信息，包括master node和host和ip（redis.conf中的replicaof配置），此时复制流程未开始</li>
<li>slave node内部有个定时任务，每秒检查是否有新的master node需要连接和复制，如果发现，则跟master node建立网络连接</li>
<li>slave node发送ping命令给master node</li>
<li>口令认证，如果master设置requirepass，那么slave node必须发送masterauth口令进行认证</li>
<li>master node第一次执行全量复制，将所有数据发送给slave node</li>
<li>master node 后续持续将写命令异步复制给slave node</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="6-2-Redis主从架构配置"><a href="#6-2-Redis主从架构配置" class="headerlink" title="6.2  Redis主从架构配置"></a>6.2  Redis主从架构配置</h4><p>注意：</p>
<p>主从架构瓶颈在于，主从节点数据内容是一致的，即全量副本。那么单机内存容量就是Redis主从架构集群的瓶颈，如果遇到Redis节点对应的硬件设备低于其他节点，那么还会出现木桶效应。</p>
<p>当然为了优化单机性能，提供缓存淘汰策略，如LRU，保证内存中的数据都是有用无冗余的数据，但是也无法解决单机瓶颈的问题。</p>
<p>为解决单机瓶颈问题，Redis集群方案势在必行，支持横向扩容，增加master节点，数据分散到各个master节点上，Redis Cluster是官方提供的集群方案，多个master节点，读写分离架构，高可用。</p>
<p>Redis集群场景：</p>
<ul>
<li>海量数据： Redis Cluster方案</li>
<li>常规数据量：Replication方案，master + 多slave + 哨兵集群+ 读写分离</li>
</ul>
<p><strong>主从复制，主机接受读写请求，从机同步主机数据</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#指定主节点。旧版本是：slaveof</span><br><span class="line">replicaof</span><br><span class="line"></span><br><span class="line">#master的密码 </span><br><span class="line">masterauth</span><br><span class="line"></span><br><span class="line"># Redis新版本从机配置</span><br><span class="line">################################# REPLICATION #################################</span><br><span class="line"></span><br><span class="line"># Master-Replica replication. Use replicaof to make a Redis instance a copy of</span><br><span class="line"># another Redis server. A few things to understand ASAP about Redis replication.</span><br><span class="line">#</span><br><span class="line">#   +------------------+      +---------------+</span><br><span class="line">#   |      Master      | ---&gt; |    Replica    |</span><br><span class="line">#   | (receive writes) |      |  (exact copy) |</span><br><span class="line">#   +------------------+      +---------------+</span><br><span class="line">#</span><br><span class="line"># 1) Redis replication is asynchronous, but you can configure a master to</span><br><span class="line">#    stop accepting writes if it appears to be not connected with at least</span><br><span class="line">#    a given number of replicas.</span><br><span class="line"># 2) Redis replicas are able to perform a partial resynchronization with the</span><br><span class="line">#    master if the replication link is lost for a relatively small amount of</span><br><span class="line">#    time. You may want to configure the replication backlog size (see the next</span><br><span class="line">#    sections of this file) with a sensible value depending on your needs.</span><br><span class="line"># 3) Replication is automatic and does not need user intervention. After a</span><br><span class="line">#    network partition replicas automatically try to reconnect to masters</span><br><span class="line">#    and resynchronize with them.</span><br><span class="line">#</span><br><span class="line"># replicaof &lt;masterip&gt; &lt;masterport&gt;</span><br><span class="line">replicaof 192.168.1.105 6379</span><br><span class="line"></span><br><span class="line"># If the master is password protected (using the &quot;requirepass&quot; configuration</span><br><span class="line"># directive below) it is possible to tell the replica to authenticate before</span><br><span class="line"># starting the replication synchronization process, otherwise the master will</span><br><span class="line"># refuse the replica request.</span><br><span class="line">#</span><br><span class="line"># masterauth &lt;master-password&gt;</span><br><span class="line"></span><br><span class="line"># 注意，如果在从机上执行写操作，报错</span><br><span class="line">127.0.0.1:6379&gt; set redis in-action</span><br><span class="line">(error) READONLY You can&apos;t write against a read only replica.</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看主从复制集群状态</span></span><br><span class="line">[root@centos-p162 redis]# redis-cli -h 192.168.1.161 -p 6379</span><br><span class="line">192.168.1.161:6379&gt; info replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=192.168.1.162,port=6379,state=online,offset=997112,lag=0</span><br><span class="line">slave1:ip=192.168.1.160,port=6379,state=online,offset=997112,lag=0</span><br><span class="line">master_replid:c32bc282c4f142e5c093b676cc0b0c1c0a37aef6</span><br><span class="line">master_replid2:0ae1879931ea6ce640f40654e7e5b30217853f31</span><br><span class="line">master_repl_offset:997126</span><br><span class="line">second_repl_offset:914459</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:997126</span><br></pre></td></tr></table></figure>
<h4 id="6-3-Redis主从高可用"><a href="#6-3-Redis主从高可用" class="headerlink" title="6.3 Redis主从高可用"></a>6.3 Redis主从高可用</h4><p>高可用受很多因素影响，如何保证高可用是每个架构师必须考虑的问题。</p>
<p>系统架构要求4个9什么意思？ 开发的系统保证在全年365天99.99%时间内可用（现在主流的说法是5个9，那么架构难度就更高），那么称为高可用。</p>
<p>如何描述Redis主从高可用？</p>
<p>如果一主多从的Redis主从复制架构，没有做高可用方案，其中一台从机挂掉，不影响可用性；但是如果主机挂掉，那么不能接受写请求，Redis就不可用了，请求就会打到MySQL数据库，后果非常严重。</p>
<p>高可用方案，故障转移failover，master故障时，自动检测，并将slave自动切换为新的master，主备切换。但是注意主备切换过程，无法对外提供服务。</p>
<h3 id="7-Redis哨兵机制"><a href="#7-Redis哨兵机制" class="headerlink" title="7 Redis哨兵机制"></a>7 Redis哨兵机制</h3><h4 id="7-1-Redis数据丢失问题"><a href="#7-1-Redis数据丢失问题" class="headerlink" title="7.1 Redis数据丢失问题"></a>7.1 Redis数据丢失问题</h4><h5 id="7-1-1-异步复制"><a href="#7-1-1-异步复制" class="headerlink" title="7.1.1 异步复制"></a>7.1.1 异步复制</h5><p>master异步复制数据给slave节点，在slave节点未接到数据时，master 宕机，此时slave被切换为master对外提供读写服务，那么旧的master想要复制的那部分数据丢失。</p>
<h5 id="7-1-2-网络分区，脑裂问题"><a href="#7-1-2-网络分区，脑裂问题" class="headerlink" title="7.1.2 网络分区，脑裂问题"></a>7.1.2 网络分区，脑裂问题</h5><p>网络分区导致出现两个master对外提供读写服务，网络恢复后会丢失部分数据</p>
<h5 id="7-1-3-Redis减少数据丢失方案"><a href="#7-1-3-Redis减少数据丢失方案" class="headerlink" title="7.1.3 Redis减少数据丢失方案"></a>7.1.3 Redis减少数据丢失方案</h5><p>Redis提供解决方案，控制若干从节点复制数据的延迟不能超过指定时间，如果超限，那么master将暂缓对外提供服务，内部等待从节点复制追上master要求的阈值。此方案能够将由于异步复制数据带来的数据丢失问题，限制在可控范围。</p>
<p>如果配置该方案，那么客户端需要做降级处理，比如临时将数据存储到本地磁盘或者依赖消息中间件临时存放队列，然后等redis master节点继续提供写请求服务时，再将数据写入master。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># It is possible for a master to stop accepting writes if there are less than</span><br><span class="line"># N replicas connected, having a lag less or equal than M seconds.</span><br><span class="line">#</span><br><span class="line"># The N replicas need to be in &quot;online&quot; state.</span><br><span class="line">#</span><br><span class="line"># The lag in seconds, that must be &lt;= the specified value, is calculated from</span><br><span class="line"># the last ping received from the replica, that is usually sent every second.</span><br><span class="line">#</span><br><span class="line"># This option does not GUARANTEE that N replicas will accept the write, but</span><br><span class="line"># will limit the window of exposure for lost writes in case not enough replicas</span><br><span class="line"># are available, to the specified number of seconds.</span><br><span class="line">#</span><br><span class="line"># For example to require at least 3 replicas with a lag &lt;= 10 seconds use:</span><br><span class="line"># 举例：需要满足至少3个从节点数据同步与master对比延迟低于10s</span><br><span class="line"> min-replicas-to-write 3</span><br><span class="line"> min-replicas-max-lag 10</span><br><span class="line">#</span><br><span class="line"># Setting one or the other to 0 disables the feature.</span><br><span class="line">#</span><br><span class="line"># By default min-replicas-to-write is set to 0 (feature disabled) and</span><br><span class="line"># min-replicas-max-lag is set to 10.</span><br></pre></td></tr></table></figure>
<h4 id="7-2-哨兵简介"><a href="#7-2-哨兵简介" class="headerlink" title="7.2 哨兵简介"></a>7.2 哨兵简介</h4><p>Redis主从复制缺点：</p>
<p>无法监控redis master动态选举，需要用sentinel机制完成动态选举。</p>
<ul>
<li>哨兵（Sentinel）进程是用于监控Redis集群中Master主服务器工作的状态</li>
<li><p>在Master主服务器发送故障的时候，可以实现Master和Slave服务器切换，保证系统的高可用（HA）</p>
</li>
<li><p>哨兵已经被集成在redis2.6+版本中，Redis的哨兵模式在2.8版本后就已经稳定</p>
</li>
</ul>
<h4 id="7-3-哨兵进程的作用"><a href="#7-3-哨兵进程的作用" class="headerlink" title="7.3 哨兵进程的作用"></a>7.3 哨兵进程的作用</h4><ul>
<li><p>监控（Monitoring）</p>
<p>哨兵不断检查Master和Slave是否运转正常</p>
</li>
<li><p>提醒（Notification）</p>
<p>当监控的某个Redis节点出现的问题时，哨兵可以通过API向管理员或者其他应用程序发送通知</p>
</li>
<li><p>自动故障迁移（Automatic failover）</p>
<p>当一个Master不能正常工作时，哨兵会开始自动故障迁移操作，具体操作如下：</p>
<ul>
<li>哨兵将失效Master的其中一个Slave升级为新的Master，并让失效Master的其他Slave改为复制新的Master；</li>
<li>当客户端试图连接失效的Master时，集群也会向客户端返回新Master的地址，使得集群可以使用现在的Master替换失效Master；</li>
<li>Master和Slave服务器切换后，Master的redis.conf、Slave的redis.conf和sentinel.conf的配置文件的内容都会发生相应的改变，即Master主服务器的redis.conf配置文件中会多一行replicaof的配置，sentinel.conf的监控目标会随之调换；</li>
</ul>
</li>
</ul>
<h4 id="7-4-哨兵原理"><a href="#7-4-哨兵原理" class="headerlink" title="7.4 哨兵原理"></a>7.4 哨兵原理</h4><h5 id="7-4-1-Redis宕机"><a href="#7-4-1-Redis宕机" class="headerlink" title="7.4.1 Redis宕机"></a>7.4.1 Redis宕机</h5><ul>
<li><p><strong>sdown 主观宕机</strong></p>
<p>如果一个哨兵自己觉得一个master宕机，那么标记该master为主观宕机</p>
<p>哨兵ping一个master，超过is-master-down-after-milliseconds指定的毫秒数，认为master宕机</p>
</li>
<li><p><strong>odown 客观宕机</strong></p>
<p>如果quorum数量的哨兵都认为某个master宕机，那么该master为客观宕机</p>
</li>
</ul>
<h5 id="7-4-2-哨兵和slave集群的自动发现机制"><a href="#7-4-2-哨兵和slave集群的自动发现机制" class="headerlink" title="7.4.2 哨兵和slave集群的自动发现机制"></a>7.4.2 哨兵和slave集群的自动发现机制</h5><p>哨兵之间的发现，通过redis的pub/</p>
<p>sub系统实现，每个哨兵会往sentinel:hello这个channel发送消息，其他哨兵均可消费该消息，感知其他哨兵的存在，每间隔2s，每个哨兵都往自己监控的某个master+slaves对应的sentinel:hello channel发送一个消息，内容是自己的host、ip和runid还有该master的监控配置</p>
<p>每个哨兵也会去监听自己监控的每个master+slaves对应的sentinel:hello channel,然后感知同样在监听该master+slaves的其他哨兵的存在</p>
<p>每个哨兵还会跟其他哨兵交换对master的监控配置，互相进行监控配置的同步</p>
<h5 id="7-4-3-slave配置的自动纠正"><a href="#7-4-3-slave配置的自动纠正" class="headerlink" title="7.4.3 slave配置的自动纠正"></a>7.4.3 slave配置的自动纠正</h5><p>哨兵会负责自动纠正slave的一些配置，比如slave如果成为潜在的master候选人，哨兵确保slave在复制现有master的数据</p>
<p>如果slave连接到一个错误的master，比如故障转移之后，那么哨兵会确保它们连接到正确的master上。</p>
<h5 id="7-4-4-slave-gt-master选举算法"><a href="#7-4-4-slave-gt-master选举算法" class="headerlink" title="7.4.4 slave -&gt; master选举算法"></a>7.4.4 slave -&gt; master选举算法</h5><p>如果一个master被认为odown，而majority哨兵都允许主备切换，那么某个哨兵就会执行主备切换操作，此时需要先选举出一个slave，会考虑slave的信息：</p>
<ul>
<li>跟master断开连接的时长</li>
<li>slave优先级</li>
<li>复制的offset</li>
<li>runid</li>
</ul>
<p>如果一个slave和master断开连接已经超过down-after-milliseconds的10倍，外加master宕机的时长，那么slave就被认为不适合选举为master</p>
<p>对slave排序：</p>
<ul>
<li>按照slave优先级排序，slave priority越低，优先级就越高</li>
<li>如果slave priority相同，那么看replica offset，哪个slave复制越多数据，offset越靠后，优先级越高</li>
<li>如果以上两个条件均相同，选择runid较小那个slave</li>
</ul>
<h4 id="7-5-Redis哨兵3节点搭建"><a href="#7-5-Redis哨兵3节点搭建" class="headerlink" title="7.5 Redis哨兵3节点搭建"></a>7.5 Redis哨兵3节点搭建</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"># port &lt;sentinel-port&gt;</span><br><span class="line"># The port that this sentinel instance will run on</span><br><span class="line">port 26379</span><br><span class="line"># By default Redis Sentinel does not run as a daemon. Use &apos;yes&apos; if you need it.</span><br><span class="line"># Note that Redis will write a pid file in /var/run/redis-sentinel.pid when</span><br><span class="line"># daemonized.</span><br><span class="line">daemonize yes</span><br><span class="line"># When running daemonized, Redis Sentinel writes a pid file in</span><br><span class="line"># /var/run/redis-sentinel.pid by default. You can specify a custom pid file</span><br><span class="line"># location here.</span><br><span class="line">pidfile &quot;/var/run/redis-sentinel.pid&quot;</span><br><span class="line"></span><br><span class="line"># Specify the log file name. Also the empty string can be used to force</span><br><span class="line"># Sentinel to log on the standard output. Note that if you use standard</span><br><span class="line"># output for logging but daemonize, logs will be sent to /dev/null</span><br><span class="line">logfile &quot;/usr/apps/redis/logs/redis-sentinel.log&quot;</span><br><span class="line"># sentinel announce-ip &lt;ip&gt;</span><br><span class="line"># sentinel announce-port &lt;port&gt;</span><br><span class="line">#</span><br><span class="line"># The above two configuration directives are useful in environments where,</span><br><span class="line"># because of NAT, Sentinel is reachable from outside via a non-local address.</span><br><span class="line">#</span><br><span class="line"># When announce-ip is provided, the Sentinel will claim the specified IP address</span><br><span class="line"># in HELLO messages used to gossip its presence, instead of auto-detecting the</span><br><span class="line"># local address as it usually does.</span><br><span class="line">#</span><br><span class="line"># Similarly when announce-port is provided and is valid and non-zero, Sentinel</span><br><span class="line"># will announce the specified TCP port.</span><br><span class="line">#</span><br><span class="line"># The two options don&apos;t need to be used together, if only announce-ip is</span><br><span class="line"># provided, the Sentinel will announce the specified IP and the server port</span><br><span class="line"># as specified by the &quot;port&quot; option. If only announce-port is provided, the</span><br><span class="line"># Sentinel will announce the auto-detected local IP and the specified port.</span><br><span class="line">#</span><br><span class="line"># Example:</span><br><span class="line">#</span><br><span class="line"># sentinel announce-ip 1.2.3.4</span><br><span class="line"></span><br><span class="line"># dir &lt;working-directory&gt;</span><br><span class="line"># Every long running process should have a well-defined working directory.</span><br><span class="line"># For Redis Sentinel to chdir to /tmp at startup is the simplest thing</span><br><span class="line"># for the process to don&apos;t interfere with administrative tasks such as</span><br><span class="line"># unmounting filesystems.</span><br><span class="line">dir &quot;/usr/apps/redis/sentinel&quot;</span><br><span class="line"># sentinel parallel-syncs &lt;master-name&gt; &lt;numreplicas&gt;</span><br><span class="line">#</span><br><span class="line"># How many replicas we can reconfigure to point to the new replica simultaneously</span><br><span class="line"># during the failover. Use a low number if you use the replicas to serve query</span><br><span class="line"># to avoid that all the replicas will be unreachable at about the same</span><br><span class="line"># time while performing the synchronization with the master.</span><br><span class="line">sentinel monitor mymaster 192.168.1.160 6379 2</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 哨兵集群最少3个节点，才能顺利进行选举。哨兵集群可以监控多个主从复制集群</span></span><br><span class="line">[root@centos-p160 redis]# ./bin/redis-sentinel ./bin/sentinel.conf </span><br><span class="line">[root@centos-p160 redis]# tail logs/redis-sentinel.log </span><br><span class="line">7594:X 23 Sep 2019 16:42:47.487 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br><span class="line">7594:X 23 Sep 2019 16:42:47.487 # Redis version=5.0.5, bits=64, commit=00000000, modified=0, pid=7594, just started</span><br><span class="line">7594:X 23 Sep 2019 16:42:47.487 # Configuration loaded</span><br><span class="line">7595:X 23 Sep 2019 16:42:47.490 * Increased maximum number of open files to 10032 (it was originally set to 1024).</span><br><span class="line">7595:X 23 Sep 2019 16:42:47.492 * Running mode=sentinel, port=26379.</span><br><span class="line">7595:X 23 Sep 2019 16:42:47.492 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span><br><span class="line">7595:X 23 Sep 2019 16:42:47.492 # Sentinel ID is 2305faed6805cf7db752cff6d4573426ffa9957b</span><br><span class="line">7595:X 23 Sep 2019 16:42:47.492 # +monitor master mymaster 192.168.1.160 6379 quorum 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 记录新增一个哨兵节点</span></span><br><span class="line">7595:X 23 Sep 2019 16:42:58.030 * +sentinel sentinel 756d6dec0cf2dbfb1bbce9b663d749643a826be1 192.168.1.161 26379 @ mymaster 192.168.1.160 6379</span><br><span class="line">7595:X 23 Sep 2019 16:43:05.470 * +sentinel sentinel f4ce4c397dda166939651ffe0f4878a2a7f49d3c 192.168.1.162 26379 @ mymaster 192.168.1.160 6379</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看哨兵集群</span></span><br><span class="line">[root@centos-p161 redis]# redis-cli -h 192.168.1.161 -p 26379</span><br><span class="line">192.168.1.161:26379&gt; sentinel sentinels mymaster</span><br><span class="line">1)  1) "name"</span><br><span class="line">    2) "f4ce4c397dda166939651ffe0f4878a2a7f49d3c"</span><br><span class="line">    3) "ip"</span><br><span class="line">    4) "192.168.1.162"</span><br><span class="line">    5) "port"</span><br><span class="line">    6) "26379"</span><br><span class="line">    7) "runid"</span><br><span class="line">    8) "f4ce4c397dda166939651ffe0f4878a2a7f49d3c"</span><br><span class="line">    9) "flags"</span><br><span class="line">   10) "sentinel"</span><br><span class="line">   11) "link-pending-commands"</span><br><span class="line">   12) "0"</span><br><span class="line">   13) "link-refcount"</span><br><span class="line">   14) "1"</span><br><span class="line">   15) "last-ping-sent"</span><br><span class="line">   16) "0"</span><br><span class="line">   17) "last-ok-ping-reply"</span><br><span class="line">   18) "1018"</span><br><span class="line">   19) "last-ping-reply"</span><br><span class="line">   20) "1018"</span><br><span class="line">   21) "down-after-milliseconds"</span><br><span class="line">   22) "30000"</span><br><span class="line">   23) "last-hello-message"</span><br><span class="line">   24) "372"</span><br><span class="line">   25) "voted-leader"</span><br><span class="line">   26) "?"</span><br><span class="line">   27) "voted-leader-epoch"</span><br><span class="line">   28) "1"</span><br><span class="line">2)  1) "name"</span><br><span class="line">    2) "2305faed6805cf7db752cff6d4573426ffa9957b"</span><br><span class="line">    3) "ip"</span><br><span class="line">    4) "192.168.1.160"</span><br><span class="line">    5) "port"</span><br><span class="line">    6) "26379"</span><br><span class="line">    7) "runid"</span><br><span class="line">    8) "2305faed6805cf7db752cff6d4573426ffa9957b"</span><br><span class="line">    9) "flags"</span><br><span class="line">   10) "sentinel"</span><br><span class="line">   11) "link-pending-commands"</span><br><span class="line">   12) "0"</span><br><span class="line">   13) "link-refcount"</span><br><span class="line">   14) "1"</span><br><span class="line">   15) "last-ping-sent"</span><br><span class="line">   16) "0"</span><br><span class="line">   17) "last-ok-ping-reply"</span><br><span class="line">   18) "1018"</span><br><span class="line">   19) "last-ping-reply"</span><br><span class="line">   20) "1018"</span><br><span class="line">   21) "down-after-milliseconds"</span><br><span class="line">   22) "30000"</span><br><span class="line">   23) "last-hello-message"</span><br><span class="line">   24) "1110"</span><br><span class="line">   25) "voted-leader"</span><br><span class="line">   26) "?"</span><br><span class="line">   27) "voted-leader-epoch"</span><br><span class="line">   28) "1"</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">测试容灾，哨兵监控160主机master，当master宕机，然后再恢复，查看如下日志</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 主观宕机</span></span><br><span class="line">7595:X 23 Sep 2019 21:42:48.288 # +sdown master mymaster 192.168.1.160 6379</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客观宕机</span></span><br><span class="line">7595:X 23 Sep 2019 21:42:48.355 # +odown master mymaster 192.168.1.160 6379 #quorum 2/2</span><br><span class="line">7595:X 23 Sep 2019 21:42:48.355 # +new-epoch 3</span><br><span class="line">7595:X 23 Sep 2019 21:42:48.355 # +try-failover master mymaster 192.168.1.160 6379</span><br><span class="line">7595:X 23 Sep 2019 21:42:48.363 # +vote-for-leader 2305faed6805cf7db752cff6d4573426ffa9957b 3</span><br><span class="line">7595:X 23 Sep 2019 21:42:48.411 # 756d6dec0cf2dbfb1bbce9b663d749643a826be1 voted for 756d6dec0cf2dbfb1bbce9b663d749643a826be1 3</span><br><span class="line">7595:X 23 Sep 2019 21:42:48.420 # f4ce4c397dda166939651ffe0f4878a2a7f49d3c voted for 2305faed6805cf7db752cff6d4573426ffa9957b 3</span><br><span class="line">7595:X 23 Sep 2019 21:42:48.441 # +elected-leader master mymaster 192.168.1.160 6379</span><br><span class="line">7595:X 23 Sep 2019 21:42:48.441 # +failover-state-select-slave master mymaster 192.168.1.160 6379</span><br><span class="line"><span class="meta">#</span><span class="bash"> 选举出161 slave切换为新的master</span></span><br><span class="line">7595:X 23 Sep 2019 21:42:48.513 # +selected-slave slave 192.168.1.161:6379 192.168.1.161 6379 @ mymaster 192.168.1.160 6379</span><br><span class="line">7595:X 23 Sep 2019 21:42:48.513 * +failover-state-send-slaveof-noone slave 192.168.1.161:6379 192.168.1.161 6379 @ mymaster 192.168.1.160 6379</span><br><span class="line">7595:X 23 Sep 2019 21:42:48.568 * +failover-state-wait-promotion slave 192.168.1.161:6379 192.168.1.161 6379 @ mymaster 192.168.1.160 6379</span><br><span class="line">7595:X 23 Sep 2019 21:42:48.677 # +promoted-slave slave 192.168.1.161:6379 192.168.1.161 6379 @ mymaster 192.168.1.160 6379</span><br><span class="line">7595:X 23 Sep 2019 21:42:48.677 # +failover-state-reconf-slaves master mymaster 192.168.1.160 6379</span><br><span class="line">7595:X 23 Sep 2019 21:42:48.709 * +slave-reconf-sent slave 192.168.1.162:6379 192.168.1.162 6379 @ mymaster 192.168.1.160 6379</span><br><span class="line">7595:X 23 Sep 2019 21:42:49.485 # -odown master mymaster 192.168.1.160 6379</span><br><span class="line">7595:X 23 Sep 2019 21:42:49.673 * +slave-reconf-inprog slave 192.168.1.162:6379 192.168.1.162 6379 @ mymaster 192.168.1.160 6379</span><br><span class="line">7595:X 23 Sep 2019 21:42:49.673 * +slave-reconf-done slave 192.168.1.162:6379 192.168.1.162 6379 @ mymaster 192.168.1.160 6379</span><br><span class="line">7595:X 23 Sep 2019 21:42:49.728 # +failover-end master mymaster 192.168.1.160 6379</span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换master到161主机</span></span><br><span class="line">7595:X 23 Sep 2019 21:42:49.728 # +switch-master mymaster 192.168.1.160 6379 192.168.1.161 6379</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启160，此时该主机已经变为slave</span></span><br><span class="line">7595:X 23 Sep 2019 21:42:49.728 * +slave slave 192.168.1.162:6379 192.168.1.162 6379 @ mymaster 192.168.1.161 6379</span><br><span class="line">7595:X 23 Sep 2019 21:42:49.728 * +slave slave 192.168.1.160:6379 192.168.1.160 6379 @ mymaster 192.168.1.161 6379</span><br><span class="line">7595:X 23 Sep 2019 21:43:19.761 # +sdown slave 192.168.1.160:6379 192.168.1.160 6379 @ mymaster 192.168.1.161 6379</span><br><span class="line">7595:X 23 Sep 2019 21:45:28.487 # -sdown slave 192.168.1.160:6379 192.168.1.160 6379 @ mymaster 192.168.1.161 6379</span><br></pre></td></tr></table></figure>
<h2 id="二、Redis集群搭建"><a href="#二、Redis集群搭建" class="headerlink" title="二、Redis集群搭建"></a>二、Redis集群搭建</h2><h3 id="1-环境基础"><a href="#1-环境基础" class="headerlink" title="1 环境基础"></a>1 环境基础</h3><p>为了能更好的模拟生产环境的网络拓扑，Redis集群需要在多节点部署，实现方案采用CentOS集群。</p>
<h4 id="1-1-CentOS集群搭建"><a href="#1-1-CentOS集群搭建" class="headerlink" title="1.1 CentOS集群搭建"></a>1.1 CentOS集群搭建</h4><ul>
<li><p>安装虚拟机软件</p>
<p><a href="https://www.virtualbox.org/" target="_blank" rel="noopener">虚拟机软件VirtualBox</a></p>
<ul>
<li>创建虚拟机实例，根据引导进行创建，选择CentOS镜像进行Linux系统安装，注意网络配置选择”桥接模式”</li>
</ul>
</li>
<li><p>下载CentOS镜像</p>
<p><a href="https://www.centos.org/" target="_blank" rel="noopener">CentOS官网</a></p>
</li>
<li><p>安装CentOS后进行网络配置，使虚拟机中的CentOS可以上网</p>
<ul>
<li>static 虚拟机IP地址</li>
<li>修改/etc/hosts 本机IP地址映射域名，使得宿主机可以访问</li>
</ul>
</li>
<li><p>SecureCRT或Xshell在宿主机上管理虚拟机</p>
</li>
<li><p>虚拟机防火墙关闭，或是放行需要的端口号</p>
</li>
<li><p>CenOS通过ssh配置免密通信</p>
</li>
</ul>
<h4 id="1-2-Redis集群环境搭建"><a href="#1-2-Redis集群环境搭建" class="headerlink" title="1.2 Redis集群环境搭建"></a>1.2 Redis集群环境搭建</h4><h5 id="1-2-1-Redis开机自启动配置"><a href="#1-2-1-Redis开机自启动配置" class="headerlink" title="1.2.1 Redis开机自启动配置"></a>1.2.1 Redis开机自启动配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 将redis初始化脚本复制到/etc/init.d目录下</span></span><br><span class="line">cp /usr/apps/redis-5.0.5/utils/redis_init_script /etc/init.d</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> redis_init_script配置文件内容如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Simple Redis init.d script conceived to work on Linux systems</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> as it does use of the /proc filesystem.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## BEGIN INIT INFO</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Provides:     redis_6379</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Default-Start:        2 3 4 5</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Default-Stop:         0 1 6</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Short-Description:    Redis data structure server</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Description:          Redis data structure server. See https://redis.io</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## END INIT INFO</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">端口号配置</span></span><br><span class="line">REDISPORT=6379</span><br><span class="line"><span class="meta">#</span><span class="bash">redis-server路径</span></span><br><span class="line">EXEC=/usr/apps/redis/bin/redis-server</span><br><span class="line"><span class="meta">#</span><span class="bash">redis-cli路径</span></span><br><span class="line">CLIEXEC=/usr/apps/redis/bin/redis-cli</span><br><span class="line"></span><br><span class="line">PIDFILE=/var/run/redis_$&#123;REDISPORT&#125;.pid</span><br><span class="line"><span class="meta">#</span><span class="bash">CONF=<span class="string">"/etc/redis/<span class="variable">$&#123;REDISPORT&#125;</span>.conf"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">redis配置文件路径</span></span><br><span class="line">CONF="/usr/apps/redis/bin/redis.conf"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置好即可在/etc/init.d路径下执行 ./redis_init_script start启动redis</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意：如果重命名脚本，需要chmod 777 新脚本名称</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 脚本加入如下注释：</span></span><br><span class="line"><span class="meta">	#</span><span class="bash"> chkconfig:   2345 90 10</span></span><br><span class="line"><span class="meta">	#</span><span class="bash"> description: Redis is a persistent key-value database</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启脚本随系统启动而执行，即开机就启动redis</span></span><br><span class="line">chkconfig redis_init_script on</span><br></pre></td></tr></table></figure>
<h4 id="1-3-Redis集群"><a href="#1-3-Redis集群" class="headerlink" title="1.3 Redis集群"></a>1.3 Redis集群</h4><p><a href="https://redis.io/topics/cluster-tutorial/" target="_blank" rel="noopener">Redis集群官方文档</a></p>
<p>Redis3.0以后推出redis cluster集群方案，redis cluster集群保证高可用、高性能、高可扩展性。</p>
<h5 id="1-3-1-Redis集群策略"><a href="#1-3-1-Redis集群策略" class="headerlink" title="1.3.1 Redis集群策略"></a>1.3.1 Redis集群策略</h5><p><a href="https://segmentfault.com/a/1190000019914100" target="_blank" rel="noopener">redis-Cluster第一篇分区方案&amp;应用场景篇</a></p>
<blockquote>
<p>之所以有如下多种Redis集群策略，是因为Redis官网3.0版本才推出分布式解决方案，Redis Cluster。</p>
</blockquote>
<ul>
<li>Twitter： twemproxy（基于代理层的redis集群方案）</li>
<li>豌豆荚：codis（基于代理层的redis集群方案）</li>
<li>官方：redis cluster（无中间代理层）</li>
</ul>
<h5 id="1-3-2-Redis集群架构细节"><a href="#1-3-2-Redis集群架构细节" class="headerlink" title="1.3.2 Redis集群架构细节"></a>1.3.2 Redis集群架构细节</h5><p><img src="E:\Architect\TechSnail\Redis\Redis核心知识梳理.assets\1569068020757.png" alt="1569068020757"></p>
<p>如上图所示，该集群中包含 6 个 Redis 节点，3主3从，分别为M1，M2，M3，S1，S2，S3。除了主从 Redis 节点之间进行数据复制外，所有 Redis 节点之间采用 Gossip 协议进行通信，交换维护节点元数据信息。</p>
<p><strong>数据分片策略</strong></p>
<p><a href="https://www.cnblogs.com/lowmanisbusy/p/10993748.html" target="_blank" rel="noopener">Redis Cluster数据分片机制</a></p>
<p>分布式数据存储方案中最为重要的一点就是数据分片，也就是所谓的 Sharding。</p>
<p>为了使得集群能够水平扩展，首要解决的问题就是如何将整个数据集按照一定的规则分配到多个节点上，常用的数据分片的方法有：</p>
<ul>
<li><p>范围分片</p>
<p>范围分片假设数据集是有序，将顺序相临近的数据放在一起，可以很好的支持遍历操作。范围分片的缺点是面对顺序写时，会存在热点。比如日志类型的写入，一般日志的顺序都是和时间相关的，时间是单调递增的，因此写入的热点永远在最后一个分片。</p>
</li>
<li><p>哈希分片</p>
</li>
<li><p>一致性哈希算法</p>
</li>
<li><p>虚拟哈希槽</p>
</li>
</ul>
<p><strong>Redis Cluster 采用虚拟哈希槽分区</strong>，所有的键根据哈希函数映射到 0 ~ 16383 整数槽内，计算公式：slot = CRC16(key) &amp; 16383。每一个节点负责维护一部分槽以及槽所映射的键值数据。</p>
<p>Redis 集群提供了灵活的节点扩容和收缩方案。在不影响集群对外服务的情况下，可以为集群添加节点进行扩容也可以下线部分节点进行缩容。可以说，<strong>槽是 Redis 集群管理数据的基本单位</strong>，集群伸缩就是槽和数据在节点之间的移动。</p>
<p><img src="E:\Architect\TechSnail\Redis\Redis核心知识梳理.assets\1569068491782.png" alt="1569068491782"></p>
<p><strong>Redis集群描述</strong></p>
<ul>
<li><p>Redis节点彼此互联（PING-PONG机制），内部使用二进制协议优化传输速度和带宽；</p>
</li>
<li><p>节点的fail是通过集群中超过半数的节点检测失效才生效；</p>
</li>
<li><p>客户端与redis节点直连，不需要中间Proxy层，客户端不需要连接集群所有节点，连接集群中任何一个可用节点即可；</p>
</li>
<li><p>redis-cluster把所有物理节点映射到[0-16383] slot上，cluster负责维护node<->slot<->value;</-></-></p>
<p>Redis集群中内置16384个哈希槽，当需要在Redis集群中放置一个key-value时，redis先对key使用crc16算法算出一个结果，然后把结果对16384求余数，这样每个key都会对应一个编号在0-16383之间的哈希槽，redis会根据节点数量大致均等的将哈希槽映射到不同的节点。</p>
</li>
</ul>
<h5 id="1-3-3-Redis-cluster-投票：容错"><a href="#1-3-3-Redis-cluster-投票：容错" class="headerlink" title="1.3.3 Redis-cluster 投票：容错"></a>1.3.3 Redis-cluster 投票：容错</h5><p>如何判断redis cluster中master主节点fail？</p>
<p>如何判断redis cluster集群fail？</p>
<ul>
<li>节点失效判断：集群中所有master参与投票，如果半数以上master节点与其中一个master节点通信超过（cluster-node-timeout），认为该master节点挂掉；</li>
<li>集群失效判断：什么时候整个集群不可用（cluster_state:fail）<ul>
<li>如果集群任意master挂掉，且当前master无slave，则集群进入fail状态。可以理解成集群的[0-16383] slot映射不完全时进入fail状态；</li>
<li>如果集群超过半数以上master挂掉，无论是否存在slave，集群进入fail状态；</li>
</ul>
</li>
</ul>
<h5 id="1-3-4-Ruby环境"><a href="#1-3-4-Ruby环境" class="headerlink" title="1.3.4 Ruby环境"></a>1.3.4 Ruby环境</h5><p><a href="https://rubyinstaller.org/downloads/" target="_blank" rel="noopener">Ruby下载</a></p>
<p>Redis集群需要使用集群管理脚本redis-trib.rb，依赖Ruby环境。</p>
<ul>
<li><p>安装Ruby</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> yum方式安装ruby</span></span><br><span class="line">yum install -y ruby</span><br><span class="line"></span><br><span class="line">ruby -v</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看安装后的ruby版本</span></span><br><span class="line">ruby 2.0.0p648 (2015-12-16) [x86_64-linux]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yum install rubygems</span><br></pre></td></tr></table></figure>
<ul>
<li><p>采坑：redis requires ruby version 2.3.0，CentOS7 yum库中ruby的版本支持到 2.0.0，但是gem安装redis需要最低是2.3.0，采用rvm来更新ruby</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装curl</span></span><br><span class="line">yum -y install curl</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装rvm</span></span><br><span class="line">gpg2 --keyserver hkp://keys.gnupg.net --recv-keys D39DC0E3  </span><br><span class="line">curl -L get.rvm.io | bash -s stable</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 执行rvm安装时遇到异常</span></span><br><span class="line">[root@localhost software]# curl -L get.rvm.io | bash -s stable</span><br><span class="line"><span class="meta">  %</span><span class="bash"> Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   194  100   194    0     0     46      0  0:00:04  0:00:04 --:--:--    49</span><br><span class="line">100 24535  100 24535    0     0   1502      0  0:00:16  0:00:16 --:--:--  6385</span><br><span class="line">Downloading https://github.com/rvm/rvm/archive/1.29.9.tar.gz</span><br><span class="line">Downloading https://github.com/rvm/rvm/releases/download/1.29.9/1.29.9.tar.gz.asc</span><br><span class="line">gpg: Signature made Wed 10 Jul 2019 04:31:02 PM CST using RSA key ID 39499BDB</span><br><span class="line">gpg: Can't check signature: No public key</span><br><span class="line">GPG signature verification failed for '/usr/local/rvm/archives/rvm-1.29.9.tgz' - 'https://github.com/rvm/rvm/releases/download/1.29.9/1.29.9.tar.gz.asc'! Try to install GPG v2 and then fetch the public key:</span><br><span class="line"></span><br><span class="line">    gpg2 --keyserver hkp://pool.sks-keyservers.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB</span><br><span class="line"></span><br><span class="line">or if it fails:</span><br><span class="line"></span><br><span class="line">    command curl -sSL https://rvm.io/mpapis.asc | gpg2 --import -</span><br><span class="line">    command curl -sSL https://rvm.io/pkuczynski.asc | gpg2 --import -</span><br><span class="line"></span><br><span class="line">In case of further problems with validation please refer to https://rvm.io/rvm/security</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装错误提示，先执行如下命令</span></span><br><span class="line">gpg2 --keyserver hkp://pool.sks-keyservers.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行结果</span></span><br><span class="line">gpg: requesting key D39DC0E3 from hkp server pool.sks-keyservers.net</span><br><span class="line">gpg: requesting key 39499BDB from hkp server pool.sks-keyservers.net</span><br><span class="line">gpg: key D39DC0E3: "Michal Papis (RVM signing) &lt;mpapis@gmail.com&gt;" not changed</span><br><span class="line">gpg: key 39499BDB: public key "Piotr Kuczynski &lt;piotr.kuczynski@gmail.com&gt;" imported</span><br><span class="line">gpg: no ultimately trusted keys found</span><br><span class="line">gpg: Total number processed: 2</span><br><span class="line">gpg:               imported: 1  (RSA: 1)</span><br><span class="line">gpg:              unchanged: 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 继续安装rvm</span></span><br><span class="line">[root@localhost software]# curl -L get.rvm.io | bash -s stable</span><br><span class="line"><span class="meta">  %</span><span class="bash"> Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   194  100   194    0     0    287      0 --:--:-- --:--:-- --:--:--   287</span><br><span class="line">100 24535  100 24535    0     0   2360      0  0:00:10  0:00:10 --:--:--  5422</span><br><span class="line">Downloading https://github.com/rvm/rvm/archive/1.29.9.tar.gz</span><br><span class="line">Downloading https://github.com/rvm/rvm/releases/download/1.29.9/1.29.9.tar.gz.asc</span><br><span class="line">gpg: Signature made Wed 10 Jul 2019 04:31:02 PM CST using RSA key ID 39499BDB</span><br><span class="line">gpg: Good signature from "Piotr Kuczynski &lt;piotr.kuczynski@gmail.com&gt;"</span><br><span class="line">gpg: WARNING: This key is not certified with a trusted signature!</span><br><span class="line">gpg:          There is no indication that the signature belongs to the owner.</span><br><span class="line">Primary key fingerprint: 7D2B AF1C F37B 13E2 069D  6956 105B D0E7 3949 9BDB</span><br><span class="line">GPG verified '/usr/local/rvm/archives/rvm-1.29.9.tgz'</span><br><span class="line">Creating group 'rvm'</span><br><span class="line">Installing RVM to /usr/local/rvm/</span><br><span class="line">Installation of RVM in /usr/local/rvm/ is almost complete:</span><br><span class="line"><span class="meta">#</span><span class="bash"> rvm需要重新登录系统才生效</span></span><br><span class="line">  * First you need to add all users that will be using rvm to 'rvm' group,</span><br><span class="line">    and logout - login again, anyone using rvm will be operating with `umask u=rwx,g=rwx,o=rx`.</span><br><span class="line"></span><br><span class="line">  * To start using RVM you need to run `source /etc/profile.d/rvm.sh`</span><br><span class="line">    in all your open shell windows, in rare cases you need to reopen all shell windows.</span><br><span class="line">  * Please do NOT forget to add your users to the rvm group.</span><br><span class="line">     The installer no longer auto-adds root or users to the rvm group. Admins must do this.</span><br><span class="line">     Also, please note that group memberships are ONLY evaluated at login time.</span><br><span class="line">     This means that users must log out then back in before group membership takes effect!</span><br><span class="line">Thanks for installing RVM 🙏</span><br><span class="line">Please consider donating to our open collective to help us maintain RVM.</span><br><span class="line"></span><br><span class="line">👉  Donate: https://opencollective.com/rvm/donate</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>修改rvm下载ruby的源，到Ruby China镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gem sources --add https://gems.ruby-china.com/ --remove https://rubygems.org/</span><br><span class="line"></span><br><span class="line">[root@centos-p160 ~]# gem sources --add https://gems.ruby-china.com/ --remove https://rubygems.org/</span><br><span class="line">https://gems.ruby-china.com/ added to sources</span><br><span class="line">https://rubygems.org/ removed from sources</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看rvm库中已知的ruby版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">rvm list known</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# rvm list known</span><br><span class="line"><span class="meta">#</span><span class="bash"> MRI Rubies</span></span><br><span class="line">[ruby-]1.8.6[-p420]</span><br><span class="line">[ruby-]1.8.7[-head] # security released on head</span><br><span class="line">[ruby-]1.9.1[-p431]</span><br><span class="line">[ruby-]1.9.2[-p330]</span><br><span class="line">[ruby-]1.9.3[-p551]</span><br><span class="line">[ruby-]2.0.0[-p648]</span><br><span class="line">[ruby-]2.1[.10]</span><br><span class="line">[ruby-]2.2[.10]</span><br><span class="line">[ruby-]2.3[.8]</span><br><span class="line">[ruby-]2.4[.6]</span><br><span class="line">[ruby-]2.5[.5]</span><br><span class="line">[ruby-]2.6[.3]</span><br><span class="line">[ruby-]2.7[.0-preview1]</span><br><span class="line">ruby-head</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> forks use: rvm install ruby-head-&lt;name&gt; --url https://github.com/github/ruby.git --branch 2.2</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装一个ruby版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">rvm install 2.6.3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 过程比较耗时</span></span><br><span class="line">[root@localhost ~]# rvm install 2.6.3</span><br><span class="line">Searching for binary rubies, this might take some time.</span><br><span class="line">No binary rubies available for: centos/7/x86_64/ruby-2.6.3.</span><br><span class="line">Continuing with compilation. Please read 'rvm help mount' to get more information on binary rubies.</span><br><span class="line">Checking requirements for centos.</span><br><span class="line">Installing requirements for centos.</span><br><span class="line">Installing required packages: patch, autoconf, automake, bison, libffi-devel, libtool, patch, readline-devel, sqlite-devel, zlib-devel, openssl-devel.........................................................................................................................................................</span><br><span class="line">Requirements installation successful.</span><br><span class="line">Installing Ruby from source to: /usr/local/rvm/rubies/ruby-2.6.3, this may take a while depending on your cpu(s)...</span><br><span class="line">ruby-2.6.3 - #downloading ruby-2.6.3, this may take a while depending on your connection...</span><br><span class="line"><span class="meta">  %</span><span class="bash"> Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 13.8M  100 13.8M    0     0  11697      0  0:20:40  0:20:40 --:--:-- 13006</span><br><span class="line">ruby-2.6.3 - #extracting ruby-2.6.3 to /usr/local/rvm/src/ruby-2.6.3.....</span><br><span class="line">ruby-2.6.3 - #configuring......................................................................</span><br><span class="line">ruby-2.6.3 - #post-configuration..</span><br><span class="line">ruby-2.6.3 - #compiling................................................................................................</span><br><span class="line">ruby-2.6.3 - #installing...............................</span><br><span class="line">ruby-2.6.3 - #making binaries executable..</span><br><span class="line">ruby-2.6.3 - #downloading rubygems-3.0.6</span><br><span class="line"><span class="meta">  %</span><span class="bash"> Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  866k  100  866k    0     0   5761      0  0:02:33  0:02:33 --:--:--  6064</span><br><span class="line">No checksum for downloaded archive, recording checksum in user configuration.</span><br><span class="line">ruby-2.6.3 - #extracting rubygems-3.0.6.....</span><br><span class="line">ruby-2.6.3 - #removing old rubygems........</span><br><span class="line">ruby-2.6.3 - #installing rubygems-3.0.6...............................................</span><br><span class="line">ruby-2.6.3 - #gemset created /usr/local/rvm/gems/ruby-2.6.3@global</span><br><span class="line">ruby-2.6.3 - #importing gemset /usr/local/rvm/gemsets/global.gems................................................................</span><br><span class="line">ruby-2.6.3 - #generating global wrappers.......</span><br><span class="line">ruby-2.6.3 - #gemset created /usr/local/rvm/gems/ruby-2.6.3</span><br><span class="line">ruby-2.6.3 - #importing gemsetfile /usr/local/rvm/gemsets/default.gems evaluated to empty gem list</span><br><span class="line">ruby-2.6.3 - #generating default wrappers.......</span><br><span class="line">ruby-2.6.3 - #adjusting #shebangs for (gem irb erb ri rdoc testrb rake).</span><br><span class="line">Install of ruby-2.6.3 - #complete </span><br><span class="line">Ruby was built without documentation, to build it run: rvm docs generate-ri</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>rvm命令选择ruby版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用ruby版本</span></span><br><span class="line">rvm use 2.6.3</span><br><span class="line">Using /usr/local/rvm/gems/ruby-2.6.3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认使用ruby版本</span></span><br><span class="line">rvm use 2.6.3 --default</span><br><span class="line"><span class="meta">#</span><span class="bash"> 卸载已知ruby版本</span></span><br><span class="line">rvm remove 2.0.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看ruby版本</span></span><br><span class="line">ruby -v</span><br><span class="line">ruby 2.6.3p62 (2019-04-16 revision 67580) [x86_64-linux]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>安装ruby和redis的接口程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gem install redis</span><br><span class="line"><span class="meta">#</span><span class="bash">安装结果信息</span></span><br><span class="line">Fetching redis-4.1.3.gem</span><br><span class="line">Successfully installed redis-4.1.3</span><br><span class="line">Parsing documentation for redis-4.1.3</span><br><span class="line">Installing ri documentation for redis-4.1.3</span><br><span class="line">Done installing documentation for redis after 2 seconds</span><br><span class="line">1 gem installed</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>复制redis-trib.rb到安装目录bin文件夹下</li>
</ul>
<h5 id="1-3-5-单机安装Redis-Cluster"><a href="#1-3-5-单机安装Redis-Cluster" class="headerlink" title="1.3.5 单机安装Redis Cluster"></a>1.3.5 单机安装Redis Cluster</h5><p>Redis Cluster最少需要3台Master和3台Slave。</p>
<ul>
<li>复制Redis安装路径/bin目录，重命名7001-7006，针对每个Redis实例修改redis.conf配置文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># Accept connections on the specified port, default is 6379 (IANA #815344).</span><br><span class="line"># If port 0 is specified Redis will not listen on a TCP socket.</span><br><span class="line">port 7001</span><br><span class="line"></span><br><span class="line"># If a pid file is specified, Redis writes it where specified at startup</span><br><span class="line"># and removes it at exit.</span><br><span class="line">#</span><br><span class="line"># When the server runs non daemonized, no pid file is created if none is</span><br><span class="line"># specified in the configuration. When the server is daemonized, the pid file</span><br><span class="line"># is used even if not specified, defaulting to &quot;/var/run/redis.pid&quot;.</span><br><span class="line">#</span><br><span class="line"># Creating a pid file is best effort: if Redis is not able to create it</span><br><span class="line"># nothing bad happens, the server will start and run normally.</span><br><span class="line">pidfile /var/run/redis_7001.pid</span><br><span class="line"></span><br><span class="line"># Specify the log file name. Also the empty string can be used to force</span><br><span class="line"># Redis to log on the standard output. Note that if you use standard</span><br><span class="line"># output for logging but daemonize, logs will be sent to /dev/null</span><br><span class="line">logfile &quot;/usr/apps/redis/logs/redis_7001.log&quot;</span><br><span class="line"></span><br><span class="line"># The filename where to dump the DB</span><br><span class="line">dbfilename dump_7001.rdb</span><br><span class="line"></span><br><span class="line"># AOF and RDB persistence can be enabled at the same time without problems.</span><br><span class="line"># If the AOF is enabled on startup Redis will load the AOF, that is the file</span><br><span class="line"># with the better durability guarantees.</span><br><span class="line">#</span><br><span class="line"># Please check http://redis.io/topics/persistence for more information.</span><br><span class="line"></span><br><span class="line">appendonly yes</span><br><span class="line"></span><br><span class="line"># The name of the append only file (default: &quot;appendonly.aof&quot;)</span><br><span class="line"></span><br><span class="line">appendfilename &quot;appendonly_7001.aof&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">################################ REDIS CLUSTER  ###############################</span><br><span class="line">#</span><br><span class="line"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="line"># WARNING EXPERIMENTAL: Redis Cluster is considered to be stable code, however</span><br><span class="line"># in order to mark it as &quot;mature&quot; we need to wait for a non trivial percentage</span><br><span class="line"># of users to deploy it in production.</span><br><span class="line"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="line">#</span><br><span class="line"># Normal Redis instances can&apos;t be part of a Redis Cluster; only nodes that are</span><br><span class="line"># started as cluster nodes can. In order to start a Redis instance as a</span><br><span class="line"># cluster node enable the cluster support uncommenting the following:</span><br><span class="line"># 开启集群模式</span><br><span class="line">cluster-enabled yes</span><br><span class="line"></span><br><span class="line"># Every cluster node has a cluster configuration file. This file is not</span><br><span class="line"># intended to be edited by hand. It is created and updated by Redis nodes.</span><br><span class="line"># Every Redis Cluster node requires a different cluster configuration file.</span><br><span class="line"># Make sure that instances running in the same system do not have</span><br><span class="line"># overlapping cluster configuration file names.</span><br><span class="line"># 使得集群中每个节点单独有自己的节点配置文件，否则报错：</span><br><span class="line"># Sorry, the cluster configuration file nodes.conf is already used by a different Redis Cluster node. Please make sure that different nodes use different cluster configuration files.</span><br><span class="line">cluster-config-file nodes-7001.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>启动7001-7006对应的Redis实例</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost 7006]# ps -ef | grep redis</span><br><span class="line">root     24213     1  0 02:58 ?        00:00:01 ./redis-server *:7001 [cluster]</span><br><span class="line">root     24324     1  0 03:03 ?        00:00:00 ./redis-server *:7002 [cluster]</span><br><span class="line">root     28127     1  0 03:15 ?        00:00:00 ./redis-server *:7003 [cluster]</span><br><span class="line">root     28260     1  0 03:27 ?        00:00:00 ./redis-server *:7004 [cluster]</span><br><span class="line">root     28294     1  0 03:28 ?        00:00:00 ./redis-server *:7005 [cluster]</span><br><span class="line">root     28330     1  0 03:29 ?        00:00:00 ./redis-server *:7006 [cluster]</span><br><span class="line">root     28337 21226  0 03:29 pts/1    00:00:00 grep --color=auto redis</span><br></pre></td></tr></table></figure>
<ul>
<li>创建redis集群</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis]# ./redis-trib.rb create --replicas 1 192.168.1.101:7001 192.168.1.101:7002 192.168.1.101:7003 192.168.1.101:7004 192.168.1.101:7005 192.168.1.101:7006</span><br><span class="line"><span class="meta">#</span><span class="bash">  redis-trib.rb 废弃无效</span></span><br><span class="line">WARNING: redis-trib.rb is not longer available!</span><br><span class="line">You should use redis-cli instead.</span><br><span class="line"></span><br><span class="line">All commands and features belonging to redis-trib.rb have been moved</span><br><span class="line">to redis-cli.</span><br><span class="line">In order to use them you should call redis-cli with the --cluster</span><br><span class="line">option followed by the subcommand name, arguments and options.</span><br><span class="line"></span><br><span class="line">Use the following syntax:</span><br><span class="line">redis-cli --cluster SUBCOMMAND [ARGUMENTS] [OPTIONS]</span><br><span class="line"></span><br><span class="line">Example:</span><br><span class="line">redis-cli --cluster create 192.168.1.101:7001 192.168.1.101:7002 192.168.1.101:7003 192.168.1.101:7004 192.168.1.101:7005 192.168.1.101:7006 --cluster-replicas 1</span><br><span class="line"></span><br><span class="line">To get help about all subcommands, type:</span><br><span class="line">redis-cli --cluster help</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> redis-trib.rb 废弃无效，改为redis-cli --cluster</span></span><br><span class="line">[root@localhost bin]# ./redis-cli --cluster create 192.168.1.101:7001 192.168.1.101:7002 192.168.1.101:7003 192.168.1.101:7004 192.168.1.101:7005 192.168.1.101:7006 --cluster-replicas 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建集群的详细信息</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span></span><br><span class="line">Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">Master[2] -&gt; Slots 10923 - 16383</span><br><span class="line">Adding replica 192.168.1.101:7004 to 192.168.1.101:7001</span><br><span class="line">Adding replica 192.168.1.101:7005 to 192.168.1.101:7002</span><br><span class="line">Adding replica 192.168.1.101:7006 to 192.168.1.101:7003</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Trying to optimize slaves allocation <span class="keyword">for</span> anti-affinity</span></span><br><span class="line">[WARNING] Some slaves are in the same host as their master</span><br><span class="line">M: 644e74b549c7d63c48c3cc5009963cae6f63e404 192.168.1.101:7001</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">M: b195eb876cad13a0c5218e772a8452441278a0cf 192.168.1.101:7002</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">M: 96172fa5e8c69252ab5a0754ceccb20e6abe1993 192.168.1.101:7003</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">S: 12d9d7554134a98cc9653e8d1b95e30a27791208 192.168.1.101:7004</span><br><span class="line">   replicates 96172fa5e8c69252ab5a0754ceccb20e6abe1993</span><br><span class="line">S: b747811dd023a59f54109a70bfc86f905bf40aeb 192.168.1.101:7005</span><br><span class="line">   replicates 644e74b549c7d63c48c3cc5009963cae6f63e404</span><br><span class="line">S: dc9454fe91014045ea81bb0c553767a1e3417140 192.168.1.101:7006</span><br><span class="line">   replicates b195eb876cad13a0c5218e772a8452441278a0cf</span><br><span class="line">Can I set the above configuration? (type 'yes' to accept): yes                      </span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Nodes configuration updated</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Assign a different config epoch to each node</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span></span><br><span class="line">Waiting for the cluster to join</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Performing Cluster Check (using node 192.168.1.101:7001)</span></span><br><span class="line">M: 644e74b549c7d63c48c3cc5009963cae6f63e404 192.168.1.101:7001</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 96172fa5e8c69252ab5a0754ceccb20e6abe1993 192.168.1.101:7003</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: b195eb876cad13a0c5218e772a8452441278a0cf 192.168.1.101:7002</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: dc9454fe91014045ea81bb0c553767a1e3417140 192.168.1.101:7006</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates b195eb876cad13a0c5218e772a8452441278a0cf</span><br><span class="line">S: b747811dd023a59f54109a70bfc86f905bf40aeb 192.168.1.101:7005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 644e74b549c7d63c48c3cc5009963cae6f63e404</span><br><span class="line">S: 12d9d7554134a98cc9653e8d1b95e30a27791208 192.168.1.101:7004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 96172fa5e8c69252ab5a0754ceccb20e6abe1993</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>
<ul>
<li>查看集群命令</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 客户端连接 -c 表示集群方式连接</span></span><br><span class="line">[root@localhost bin]# ./redis-cli -h 192.168.1.101 -p 7001 -c</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看集群状态</span></span><br><span class="line">192.168.1.101:7001&gt; cluster info</span><br><span class="line">cluster_state:ok</span><br><span class="line">cluster_slots_assigned:16384</span><br><span class="line">cluster_slots_ok:16384</span><br><span class="line">cluster_slots_pfail:0</span><br><span class="line">cluster_slots_fail:0</span><br><span class="line">cluster_known_nodes:6</span><br><span class="line">cluster_size:3</span><br><span class="line">cluster_current_epoch:6</span><br><span class="line">cluster_my_epoch:1</span><br><span class="line">cluster_stats_messages_ping_sent:1168</span><br><span class="line">cluster_stats_messages_pong_sent:1148</span><br><span class="line">cluster_stats_messages_sent:2316</span><br><span class="line">cluster_stats_messages_ping_received:1143</span><br><span class="line">cluster_stats_messages_pong_received:1168</span><br><span class="line">cluster_stats_messages_meet_received:5</span><br><span class="line">cluster_stats_messages_received:2316</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看集群节点</span></span><br><span class="line">192.168.1.101:7003&gt; cluster nodes</span><br><span class="line">b747811dd023a59f54109a70bfc86f905bf40aeb 192.168.1.101:7005@17005 slave 644e74b549c7d63c48c3cc5009963cae6f63e404 0 1569012946031 1 connected</span><br><span class="line">96172fa5e8c69252ab5a0754ceccb20e6abe1993 192.168.1.101:7003@17003 myself,master - 0 1569012945000 3 connected 10923-16383</span><br><span class="line">12d9d7554134a98cc9653e8d1b95e30a27791208 192.168.1.101:7004@17004 slave 96172fa5e8c69252ab5a0754ceccb20e6abe1993 0 1569012944000 4 connected</span><br><span class="line">b195eb876cad13a0c5218e772a8452441278a0cf 192.168.1.101:7002@17002 master - 0 1569012947069 2 connected 5461-10922</span><br><span class="line">dc9454fe91014045ea81bb0c553767a1e3417140 192.168.1.101:7006@17006 slave b195eb876cad13a0c5218e772a8452441278a0cf 0 1569012943000 6 connected</span><br><span class="line">644e74b549c7d63c48c3cc5009963cae6f63e404 192.168.1.101:7001@17001 master - 0 1569012946000 1 connected 0-5460</span><br></pre></td></tr></table></figure>
<h3 id="2-数据分布算法简介"><a href="#2-数据分布算法简介" class="headerlink" title="2 数据分布算法简介"></a>2 数据分布算法简介</h3><ul>
<li><p>hash算法</p>
<p>描述：根据key计算hash值，hash与节点数取模，即求余数，根据取模结果将数据放在对应节点上。</p>
<p>问题：任意节点宕机，节点数变化，会影响取模结果，大部分请求失效，大量数据需要重新计算存入缓存。</p>
</li>
<li><p>一致性hash算法</p>
<p>描述：节点在圆环上，根据key求hash值，key值落在圆环上，就会顺时针寻找距离自己最近的一个节点。如果其中一个节点宕机，不会导致缓存全部失效。</p>
<p>一致性hash虚拟节点，负载均衡。</p>
</li>
<li><p>hash slot算法</p>
<p>描述：槽位数16384固定，数据相对均匀的分布到对应的槽位上。</p>
</li>
</ul>
<h2 id="三、Redis和Lua整合"><a href="#三、Redis和Lua整合" class="headerlink" title="三、Redis和Lua整合"></a>三、Redis和Lua整合</h2><h3 id="1-Lua介绍及环境搭建"><a href="#1-Lua介绍及环境搭建" class="headerlink" title="1 Lua介绍及环境搭建"></a>1 Lua介绍及环境搭建</h3><h4 id="1-1-Lua介绍"><a href="#1-1-Lua介绍" class="headerlink" title="1.1 Lua介绍"></a>1.1 Lua介绍</h4><p>Lua是一种轻量小巧的脚步语言，用标准C语言编写并以源码形式开发，其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p>
<h4 id="1-2-Redis使用Lua的好处"><a href="#1-2-Redis使用Lua的好处" class="headerlink" title="1.2 Redis使用Lua的好处"></a>1.2 Redis使用Lua的好处</h4><ul>
<li>减少网络开销，在Lua脚本中可以把多个命令放在同一个脚本中运行</li>
<li>原子操作，Redis会将整个脚本作为一个整体执行，中间不会被其他命令插入。换句话，编写脚本的过程中无需担心出现竞态条件</li>
<li>复用性，客户端发送的脚本会永远存在Redis中，意味着其他客户端可以复用这一脚本完成同样逻辑</li>
</ul>
<h4 id="1-3-Lua安装"><a href="#1-3-Lua安装" class="headerlink" title="1.3 Lua安装"></a>1.3 Lua安装</h4><p><a href="http://www.lua.org/download.html" target="_blank" rel="noopener">Lua官方下载</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">yum -y install readline-devel ncurses-devel</span><br><span class="line">tar -zxvf lua-5.3.5.tar.gz</span><br><span class="line">make linux</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装后输入lua -v查看版本号</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 输入lua，进入lua控制台，然后即可输入lua命令</span></span><br><span class="line">[root@localhost lua-5.3.5]# lua</span><br><span class="line">Lua 5.3.5  Copyright (C) 1994-2018 Lua.org, PUC-Rio</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="built_in">print</span>(1)</span></span><br><span class="line">1</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="built_in">print</span>(<span class="string">"hello world"</span>)</span></span><br><span class="line">hello world</span><br></pre></td></tr></table></figure>
<h4 id="1-4-Redis整合Lua脚本"><a href="#1-4-Redis整合Lua脚本" class="headerlink" title="1.4 Redis整合Lua脚本"></a>1.4 Redis整合Lua脚本</h4><p>注意： Redis2.6.0版本开始，通过内置的Lua编译/解释器，可以使用EVAL命令对Lua脚本进行求值。</p>
<p>EVAL命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Redis客户端，执行如下命令</span></span><br><span class="line">EVAL script numkeys key [key ... ] arg [arg ... ]</span><br></pre></td></tr></table></figure>
<ul>
<li>script参数： 一段Lua脚本，它会被运行在Redis服务器上下文中，该Lua脚本不必定义为一个Lua函数</li>
<li>numkeys参数: 用于指定键名参数的个数</li>
<li>key[key …]参数：从EVAL的第三个参数开始算起，使用numkeys个键（key），表示脚本中所用到的那些Redis键（Key）,这些键名参数可以在Lua中通过全局变量KEYS数组，用1为基址形式访问（KEYS[1],KEYS[2]，以此类推）</li>
<li>arg[arg …]参数：可以在Lua中通过全局变量ARGV数组访问，访问形式和KEYS变量类似（ARGV[1]、ARGV[2],诸如此类）</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://techsnail.com/2019/06/29/Redis核心知识梳理/" data-id="ck0x8n4ii0000bovpzs5v8lem" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Redis/">Redis</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2019/05/29/Dubbo之服务注册与发现/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Dubbo之服务注册与发现</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Redis/" style="font-size: 10px;">Redis</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/06/29/Redis核心知识梳理/">Redis核心知识梳理</a>
          </li>
        
          <li>
            <a href="/2019/05/29/Dubbo之服务注册与发现/">Dubbo之服务注册与发现</a>
          </li>
        
          <li>
            <a href="/2019/05/29/分布式系统架构演进/">分布式系统架构演进</a>
          </li>
        
          <li>
            <a href="/2019/05/29/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 VictorSu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>